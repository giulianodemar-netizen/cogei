<?php

/**
 * Plugin Snippet WordPress - Sistema Gestione Fornitori
 * Versione base con logica stati corretta
 * 
 * REGOLE STATI:
 * - SOA NON √® fondamentale per NESSUNO
 * - RCT-RCO NON serve per: FORNITURE, CONSULENZA, POLIZZE
 * - RCT-RCO serve per: LAVORO, SERVIZI, SUBAPPALTO, NOLI
 */

// Verifica che sia WordPress
if (!defined('ABSPATH')) {
    exit;
}

global $wpdb;
date_default_timezone_set('Europe/Rome');

// Includi logger centralizzato
require_once(ABSPATH . 'includes/log_mail.php');

// ================== CONFIGURAZIONE EMAIL ==================
$GLOBALS['inviamail'] = true; // Email ATTIVATE - Le email vengono inviate

// ================== GESTIONE EXPORT CSV ==================

if (isset($_GET['csv_export']) && $_GET['csv_export'] === '1') {
    if (ob_get_contents()) ob_clean();
    
    header('Content-Type: application/csv');
    header('Content-Disposition: attachment; filename="fornitori_' . date('Y-m-d_H-i-s') . '.csv"');
    header('Pragma: no-cache');
    header('Expires: 0');
    
    echo "\xEF\xBB\xBF";
    echo "ID,Ragione Sociale,Email,P.IVA,Stato,Data Registrazione\n";
    
    $suppliers = get_users([
        'role' => 'subscriber',
        'orderby' => 'ID',
        'order' => 'DESC'
    ]);
    foreach ($suppliers as $user) {
        $user_id = $user->ID;
        $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
        $status = determineSupplierStatus($user_id);
        
        // Get WordPress registration date
        $registration_date = '';
        if (!empty($user->user_registered)) {
            $registration_date = date('d/m/Y H:i', strtotime($user->user_registered));
        }
        
        $row = [
            $user_id,
            '"' . str_replace('"', '""', $rag_soc ?: '') . '"',
            '"' . str_replace('"', '""', $user->user_email) . '"',
            '"' . str_replace('"', '""', $user->display_name) . '"',
            '"' . str_replace('"', '""', $status) . '"',
            '"' . str_replace('"', '""', $registration_date) . '"'
        ];
        
        echo implode(',', $row) . "\n";
    }
    
    exit;
}

// ================== FUNZIONI EMAIL ==================

function sendActivationEmail($user_id) {
    $inviamail = $GLOBALS["inviamail"];
    
    $user = get_userdata($user_id);
    $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
    $email = $user->user_email;
    
    $to = $email;
    $subject = "Il tuo account su Cogei.net √® stato attivato";
    $body = "<html>
<head>
<title>Account attivato</title>
</head>
<body>
<div style='background: #03679e; text-align: center; padding: 10px; margin-bottom: 30px;'><img style='max-width: 150px;' src='https://cogei.provasiti.it/cogei/wp-content/uploads/2023/02/logo_bianco-1.png' /></div>
Salve,".$rag_soc."<br>ti informaimo che la tua richiesta di qualifica √® stata accettata. ti invitiamo a mantenere sempre aggiornata la documentazione della tua area privata.<br><br>
Cordiali Saluti,<br>
Cogei S.r.l.
<div class='footer' style='background: #03679e; padding: 10px; margin-top: 20px;'>
<div class='rigainfofo primariga'><a style='color: white; text-decoration: none;' href='#' target='_blank' rel='noopener'>Via Francesco Lomonaco, 3 - 80121 Napoli</a></div>
<div class='rigainfofo'><a style='color: white; text-decoration: none;' href='tel:+390812303782'>TEL: +39 081.230.37.82</a></div>
<div class='rigainfofo primariga'><a style='color: white; text-decoration: none;' href='mailto:cogei@pec.cogei.net'>PEC: cogei@pec.cogei.net</a></div>
<div style='margin-top: 40px; text-align: center; color: white; font-size: 12px !important;'>COGEI SRL - P.IVA: IT06569020636 - Copyright ¬© 2023 Cogei. All Rights Reserved.</div>
</div>
</body>
</html>";
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= 'From: <no-reply@cogei.net>' . "\r\n";
    $headers .= 'Cc:' . "\r\n";
    
    $email_sent = false;
    if ($inviamail) {
        $email_sent = mail($to, $subject, $body, $headers);
    }
    
    // Log centralizzato
    AlboFornitoriMailLogger::logActivation(
        $user_id,
        $rag_soc ?: 'N/A',
        $email,
        $to,
        $email_sent,
        !$inviamail // debug_mode se inviamail √® false
    );
}

function sendDeactivationEmail($user_id) {
    $inviamail = $GLOBALS["inviamail"];
    
    $user = get_userdata($user_id);
    $user_rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
    $user_email = $user->user_email;
    
    $to = $user_email;
    $subject = "Il tuo account su Cogei.net √® stato disattivato";
    $body = "<html>
<head>
<title>Account disattivato</title>
</head>
<body>
<div style='background: #03679e; text-align: center; padding: 10px; margin-bottom: 30px;'><img style='max-width: 150px;' src='https://cogei.provasiti.it/cogei/wp-content/uploads/2023/02/logo_bianco-1.png' /></div>
Gentile ".$user_rag_soc." la informiamo che la sua iscrizione √® decaduta a causa del mancato aggiornamento della documentazione.<br><br>
Per maggiori informazioni contattare <a href='mailto:ufficio_qualita@cogei.net'>ufficio_qualita@cogei.net</a>
Cordiali Saluti,<br>
Cogei SRL.
<br><br>
<div class='footer' style='background: #03679e; padding: 10px; margin-top: 20px;'>
<div class='rigainfofo primariga'><a style='color: white; text-decoration: none;' href='#' target='_blank' rel='noopener'>Via Francesco Lomonaco, 3 - 80121 Napoli</a></div>
<div class='rigainfofo'><a style='color: white; text-decoration: none;' href='tel:+390812303782'>TEL: +39 081.230.37.82</a></div>
<div class='rigainfofo primariga'><a style='color: white; text-decoration: none;' href='mailto:cogei@pec.cogei.net'>PEC: cogei@pec.cogei.net</a></div>
<div style='margin-top: 40px; text-align: center; color: white; font-size: 12px !important;'>COGEI SRL - P.IVA: IT06569020636 - Copyright ¬© 2023 Cogei. All Rights Reserved.</div>
</div>
</body>
</html>";
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= 'From: <no-reply@cogei.net>' . "\r\n";
    $headers .= 'Cc:' . "\r\n";
    
    $email_sent = false;
    if ($inviamail) {
        $email_sent = mail($to, $subject, $body, $headers);
    }
    
    // Log centralizzato
    AlboFornitoriMailLogger::logDeactivation(
        $user_id,
        $user_rag_soc ?: 'N/A',
        $user_email,
        $to,
        $email_sent,
        !$inviamail // debug_mode se inviamail √® false
    );
}

// ================== FUNZIONI HELPER ==================

function createSuppliersCopyTable() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'suppliers_copy';
    $sql = "CREATE TABLE IF NOT EXISTS $table_name (
        id int(11) NOT NULL AUTO_INCREMENT,
        user_id int(11) NOT NULL,
        tipo varchar(100),
        ragione_sociale varchar(255),
        email varchar(255),
        piva varchar(50),
        rct_rco varchar(20),
        cciaa varchar(20),
        white_list varchar(20),
        soa varchar(20),
        durc varchar(20),
        altre_scadenze varchar(20),
        stato varchar(50),
        richiesta_documenti tinyint(1) DEFAULT 0,
        last_updated datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        UNIQUE KEY user_id (user_id)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;";
    $wpdb->query($sql);
    
    $wpdb->query("ALTER TABLE $table_name ADD COLUMN IF NOT EXISTS richiesta_documenti tinyint(1) DEFAULT 0");
}

function getSupplierCopyData($user_id) {
    global $wpdb;
    $result = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM {$wpdb->prefix}suppliers_copy WHERE user_id = %d",
        $user_id
    ), ARRAY_A);
    return $result;
}

function updateSupplierCopyData($user_id, $data) {
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'suppliers_copy';
    
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '{$table_name}'");
    if (!$table_exists) {
        createSuppliersCopyTable();
    }
    
    $clean_data = $data;
    unset($clean_data['id']);
    unset($clean_data['last_updated']);
    
    if (!isset($clean_data['richiesta_documenti'])) {
        $clean_data['richiesta_documenti'] = 0;
    }
    
    $merge_data = array_merge(['user_id' => $user_id], $clean_data);
    
    $formats = ['%d'];
    foreach ($clean_data as $key => $value) {
        if ($key === 'richiesta_documenti') {
            $formats[] = '%d';
        } else {
            $formats[] = '%s';
        }
    }
    
    $result = $wpdb->replace(
        $table_name,
        $merge_data,
        $formats
    );
    
    return $result;
}

function hasDocuments($user_id) {
    $tipo = get_user_meta($user_id, 'user_registration_tip_ut_rad', true);
    
    $document_fields = [
        'user_registration_scad_CCIAA', 
        'user_registration_scad_wit', 
        'user_registration_scad_durc',
        'user_registration_scadenza_altre_scadenze'
    ];
    
    // NUOVA LOGICA: RCT-RCO serve solo per LAVORO, SERVIZI, SUBAPPALTO, NOLI
    // NON serve per: FORNITURE, CONSULENZA, POLIZZE
    if ($tipo === 'Lavoro' || $tipo === 'Servizi' || $tipo === 'Subappalto' || $tipo === 'Noli') {
        if ($tipo === 'Forniture') {
            $document_fields[] = 'user_registration_scad_rct_rco_forni';
        } else {
            $document_fields[] = 'user_registration_scad_rct_rco';
        }
    }
    
    // SOA NON √® mai fondamentale (rimosso completamente)
    
    foreach ($document_fields as $field) {
        if (!empty(get_user_meta($user_id, $field, true))) {
            return true;
        }
    }
    return false;
}

function determineSupplierStatus($user_id) {
    // Controlla se c'√® uno stato forzato manualmente
    $forced_status = get_user_meta($user_id, 'forced_supplier_status', true);
    if (!empty($forced_status)) {
        return $forced_status;
    }
    
    // Calcola stato dinamico con NUOVA LOGICA
    $tipo = get_user_meta($user_id, 'user_registration_tip_ut_rad', true);
    
    // DOCUMENTI SEMPRE FONDAMENTALI
    $documenti_fondamentali = [
        'user_registration_scad_CCIAA', 
        'user_registration_scad_wit',
        'user_registration_scad_durc',
        'user_registration_scadenza_altre_scadenze'
    ];
    
    // NUOVA LOGICA RCT-RCO: serve solo per LAVORO, SERVIZI, SUBAPPALTO, NOLI
    // NON serve per: FORNITURE, CONSULENZA, POLIZZE
    if ($tipo === 'Lavoro' || $tipo === 'Servizi' || $tipo === 'Subappalto' || $tipo === 'Noli') {
        if ($tipo === 'Forniture') {
            $documenti_fondamentali[] = 'user_registration_scad_rct_rco_forni';
        } else {
            $documenti_fondamentali[] = 'user_registration_scad_rct_rco';
        }
    }
    
    // SOA NON √® mai fondamentale (completamente rimosso)
    
    $documenti_caricati = 0;
    $documenti_totali = count($documenti_fondamentali);
    $has_expired = false;
    $expired_docs = [];
    $has_any_document = false;
    
    foreach ($documenti_fondamentali as $field) {
        $date = get_user_meta($user_id, $field, true);
        if (!empty($date)) {
            $documenti_caricati++;
            $has_any_document = true;
            
            $converted_date = str_replace("/", "-", $date);
            try {
                $now = new DateTime("now");
                $expiry_date = new DateTime($converted_date . ' 23:59:59');
                $interval = $now->diff($expiry_date);
                $days = (int)$interval->format('%r%a');
                
                if ($days < 0) {
                    $has_expired = true;
                }
                
                if ($days <= -15) {
                    $expired_docs[] = [
                        'field' => $field,
                        'days' => abs($days),
                        'date' => $date
                    ];
                }
            } catch (Exception $e) {
                // Ignora errori di data
            }
        }
    }
    
    if (!empty($expired_docs)) {
        global $disattivazione_info;
        $disattivazione_info = $expired_docs;
        $stato_base = 'Disattivo';
    } elseif ($documenti_caricati === $documenti_totali && !$has_expired) {
        $stato_base = 'Attivo';
    } elseif ($has_expired) {
        $stato_base = 'Scaduto';
    } elseif (!$has_any_document) {
        $stato_base = 'Solo_Registrato';
    } else {
        $stato_base = 'Solo_Registrato';
    }
    
    $is_waiting_integration = ($documenti_caricati > 0 && $documenti_caricati < $documenti_totali);
    
    if ($stato_base === 'Disattivo' && $is_waiting_integration) {
        return 'Disattivo_In_Attesa';
    } elseif ($stato_base === 'Solo_Registrato' && $is_waiting_integration) {
        return 'Solo_Registrato_In_Attesa';
    } else {
        return $stato_base;
    }
}

function renderExpiryCell($date) {
    if (empty($date)) {
        return "<span style='color:gray; font-style:italic;'>Non caricato</span>";
    }
    
    $converted_date = str_replace("/", "-", $date);
    try {
        $now = new DateTime("now");
        $expiry_date = new DateTime($converted_date . ' 23:59:59');
        $interval = $now->diff($expiry_date);
        
        $days = (int)$interval->format('%r%a');
        $hours = (int)$interval->format('%r%h');
        $minutes = (int)$interval->format('%r%i');
        
        $output = $date;
        
        if ($days < 0) {
            $abs_days = abs($days);
            $abs_hours = abs($hours);
            
            if ($abs_days > 0) {
                $time_text = $abs_days . " giorni";
                if ($abs_hours > 0) {
                    $time_text .= " e " . $abs_hours . " ore";
                }
            } else {
                $time_text = $abs_hours . " ore";
            }
            
            $output .= "<br><span style='color:red; font-weight:bold;'>Scaduto da: {$time_text}</span>";
            
        } elseif ($days === 0) {
            if ($hours <= 0) {
                $output .= "<br><span style='color:red; font-weight:bold;'>Scade oggi</span>";
            } else {
                $time_text = $hours . " ore";
                if ($minutes > 0) {
                    $time_text .= " e " . $minutes . " minuti";
                }
                $output .= "<br><span style='color:orange; font-weight:bold;'>Scade oggi tra: {$time_text}</span>";
            }
            
        } else {
            if ($days === 1) {
                $time_text = "1 giorno";
                if ($hours > 0 && $days <= 15) {
                    $time_text .= " e " . $hours . " ore";
                }
            } else {
                $time_text = $days . " giorni";
                if ($hours > 0 && $days <= 15) {
                    $time_text .= " e " . $hours . " ore";
                }
            }
            
            if ($days <= 15) {
                $output .= "<br><span style='color:orange; font-weight:bold;'>Scade tra: {$time_text}</span>";
            } else {
                $output .= "<br><span style='color:green;'>Scade tra: {$days} giorni</span>";
            }
        }
        
        return $output;
        
    } catch (Exception $e) {
        return $date;
    }
}

// Function to get document request for user
function getDocumentRequest($user_id) {
    global $wpdb;
    return $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM {$wpdb->prefix}document_requests WHERE user_id = %d",
        $user_id
    ), ARRAY_A);
}

// Function to check for document changes and auto-disable users
function checkDocumentChangesAndDisableUser($user_id) {
    global $wpdb;
    $inviamail = $GLOBALS['inviamail'];
    
    // Get current live data from user_meta
    $user = get_userdata($user_id);
    if (!$user) return false;
    
    $tipo = get_user_meta($user_id, 'user_registration_tip_ut_rad', true);
    $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
    
    // Check if user is newly registered (within 7 days and has no documents yet)
    $registration_time = strtotime($user->user_registered);
    $days_since_registration = (time() - $registration_time) / (60 * 60 * 24);
    $is_new_user = $days_since_registration <= 7;
    
    // Document fields to monitor
    $document_fields = [
        'user_registration_scad_CCIAA' => 'CCIAA',
        'user_registration_scad_wit' => 'White List', 
        'user_registration_scad_durc' => 'DURC',
        'user_registration_scadenza_altre_scadenze' => 'Altre Scadenze'
    ];
    
    // Add RCT-RCO field based on type
    if ($tipo === 'Lavoro' || $tipo === 'Servizi' || $tipo === 'Subappalto' || $tipo === 'Noli') {
        if ($tipo === 'Forniture') {
            $document_fields['user_registration_scad_rct_rco_forni'] = 'RCT-RCO (Forniture)';
        } else {
            $document_fields['user_registration_scad_rct_rco'] = 'RCT-RCO';
        }
    }
    
    // Get current live data
    $live_data = [];
    foreach ($document_fields as $field => $label) {
        $live_data[$field] = get_user_meta($user_id, $field, true);
    }
    
    // Count how many required documents are filled
    $filled_documents = 0;
    $total_required = count($document_fields);
    foreach ($live_data as $value) {
        if (!empty($value)) {
            $filled_documents++;
        }
    }
    
    // Get copy table data
    $copy_data = getSupplierCopyData($user_id);
    if (!$copy_data) {
        // No copy data exists yet, create it
        updateSupplierCopyData($user_id, [
            'tipo' => $tipo,
            'ragione_sociale' => $rag_soc,
            'email' => $user->user_email,
            'piva' => $user->display_name,
            'rct_rco' => $live_data['user_registration_scad_rct_rco'] ?? $live_data['user_registration_scad_rct_rco_forni'] ?? '',
            'cciaa' => $live_data['user_registration_scad_CCIAA'] ?? '',
            'white_list' => $live_data['user_registration_scad_wit'] ?? '',
            'soa' => get_user_meta($user_id, 'user_registration_scad_soa', true) ?: '',
            'durc' => $live_data['user_registration_scad_durc'] ?? '',
            'altre_scadenze' => $live_data['user_registration_scadenza_altre_scadenze'] ?? '',
            'stato' => determineSupplierStatus($user_id)
        ]);
        
        // NUOVO: Per utenti nuovi che iniziano a caricare documenti, invia notifica admin SOLO SE NON GI√Ä NOTIFICATO
        if ($is_new_user && $filled_documents > 0) {
            // Verifica se gi√† notificato con hash dei documenti correnti
            $current_state_hash = md5(json_encode($live_data));
            $last_notified_state = get_user_meta($user_id, 'last_notified_document_changes', true);
            
            // Invia notifica solo se lo stato √® cambiato
            if ($last_notified_state !== $current_state_hash) {
                sendAdminNewUserProgressNotification($user_id, $filled_documents, $total_required, $rag_soc);
                update_user_meta($user_id, 'last_notified_document_changes', $current_state_hash);
            }
        }
        
        return false; // No comparison possible on first run
    }
    
    // Compare document dates
    $changed_documents = [];
    
    // Map copy table fields to live fields
    $field_mapping = [
        'cciaa' => 'user_registration_scad_CCIAA',
        'white_list' => 'user_registration_scad_wit',
        'durc' => 'user_registration_scad_durc',
        'altre_scadenze' => 'user_registration_scadenza_altre_scadenze',
        'rct_rco' => ($tipo === 'Forniture') ? 'user_registration_scad_rct_rco_forni' : 'user_registration_scad_rct_rco'
    ];
    
    foreach ($field_mapping as $copy_field => $live_field) {
        $copy_value = $copy_data[$copy_field] ?? '';
        $live_value = $live_data[$live_field] ?? '';
        
        if ($copy_value !== $live_value && !empty($live_value)) {
            $label = $document_fields[$live_field] ?? $copy_field;
            $changed_documents[] = [
                'document' => $label,
                'old_date' => $copy_value,
                'new_date' => $live_value
            ];
        }
    }
    
    // If changes detected, process based on user status
    if (!empty($changed_documents)) {
        // NUOVO REQ 1: Verifica se le modifiche sono gi√† state notificate
        $last_notified_changes = get_user_meta($user_id, 'last_notified_document_changes', true);
        
        // Per nuovi utenti, usiamo lo stato completo dei documenti come hash
        // Per utenti esistenti, usiamo solo le modifiche
        if ($is_new_user) {
            $current_changes_hash = md5(json_encode($live_data));
        } else {
            $current_changes_hash = md5(json_encode($changed_documents));
        }
        
        // Se le modifiche sono identiche all'ultima notifica, non inviare email
        if ($last_notified_changes === $current_changes_hash) {
            return $changed_documents; // Modifiche gi√† notificate, non reinviare email
        }
        
        // NUOVO REQ 2: Gestione utenti nuovi vs esistenti
        if ($is_new_user && $filled_documents < $total_required) {
            // Utente nuovo in fase di registrazione: invia notifica progresso, NON disattivare
            sendAdminNewUserProgressNotification($user_id, $filled_documents, $total_required, $rag_soc);
            
            // Salva hash delle modifiche notificate
            update_user_meta($user_id, 'last_notified_document_changes', $current_changes_hash);
            
            return $changed_documents;
        } elseif ($is_new_user && $filled_documents === $total_required) {
            // Utente nuovo ha completato tutti i documenti: invia notifica completamento
            sendAdminNewUserCompletionNotification($user_id, $rag_soc);
            
            // Salva hash delle modifiche notificate
            update_user_meta($user_id, 'last_notified_document_changes', $current_changes_hash);
            
            return $changed_documents;
        } else {
            // Utente esistente con modifiche: comportamento originale (disattiva e notifica)
            
            // Force disable user status
            update_user_meta($user_id, 'forced_supplier_status', 'Disattivo');
            
            // Log the automatic disabling
            $log_file = ABSPATH . 'auto_disattivazione_documenti.txt';
            $timestamp = date('d/m/Y H:i:s');
            $log_entry = "[{$timestamp}] AUTO-DISATTIVAZIONE - ID: {$user_id} | Ragione Sociale: {$rag_soc} | Documenti modificati: " . count($changed_documents) . "\n";
            
            if (!file_exists($log_file)) {
                $header = "LOG AUTO-DISATTIVAZIONI PER MODIFICHE DOCUMENTI - " . date('Y') . "\n";
                $header .= str_repeat("=", 80) . "\n\n";
                file_put_contents($log_file, $header, FILE_APPEND | LOCK_EX);
            }
            file_put_contents($log_file, $log_entry, FILE_APPEND | LOCK_EX);
            
            // Send notification email to admin
            sendAdminDocumentChangeNotification($user_id, $changed_documents, $rag_soc);
            
            // Salva hash delle modifiche notificate
            update_user_meta($user_id, 'last_notified_document_changes', $current_changes_hash);
            
            return $changed_documents; // Return array of changed documents
        }
    }
    
    return false; // No changes detected
}

// Function to send admin notification about document changes
function sendAdminDocumentChangeNotification($user_id, $changed_documents, $rag_soc) {
    $inviamail = $GLOBALS["inviamail"];
    
    $admin_email = 'ufficio_qualita@cogei.net';
    $user = get_userdata($user_id);
    $user_email = $user ? $user->user_email : 'N/A';
    
    $subject = "ALERT: Disattivazione automatica fornitore per modifica documenti";
    
    $documents_list = '';
    $documenti_log = [];
    foreach ($changed_documents as $change) {
        $documents_list .= "- {$change['document']}: da '{$change['old_date']}' a '{$change['new_date']}'<br>";
        $documenti_log[] = [
            'nome' => $change['document'],
            'old_date' => $change['old_date'],
            'new_date' => $change['new_date']
        ];
    }
    
    $body = "<html>
<head>
<title>Disattivazione Automatica Fornitore</title>
</head>
<body>
<div style='background: #dc3545; color: white; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 8px;'>
<h2 style='margin: 0; color: white;'>üö® ALERT - Disattivazione Automatica</h2>
</div>

<p>Ciao Admin,</p>

<p>Il fornitore <strong>{$rag_soc}</strong> (ID: {$user_id}) √® stato <strong>automaticamente disattivato</strong> 
a causa della modifica della documentazione nel database.</p>

<div style='background: #f8d7da; padding: 15px; border-left: 4px solid #dc3545; margin: 20px 0; border-radius: 4px;'>
<h3 style='margin: 0 0 10px 0; color: #721c24;'>üìÑ Documenti modificati:</h3>
{$documents_list}
</div>

<div style='background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; border-radius: 4px;'>
<h3 style='margin: 0 0 10px 0; color: #856404;'>‚ö° Azioni automatiche eseguite:</h3>
‚Ä¢ Fornitore disattivato automaticamente<br>
‚Ä¢ Stato forzato a 'Disattivo' nel sistema<br>
‚Ä¢ Log creato in auto_disattivazione_documenti.txt<br>
</div>

<p><strong>Data rilevamento:</strong> " . date('d/m/Y H:i:s') . "</p>
<p><strong>Sistema:</strong> Controllo automatico modifiche documenti</p>

<p>√à necessario verificare manualmente le modifiche e decidere se riattivare il fornitore.</p>

<div class='footer' style='background: #03679e; padding: 10px; margin-top: 30px; border-radius: 4px;'>
<div style='text-align: center; color: white; font-size: 12px;'>
COGEI SRL - Sistema di Controllo Automatico Documenti<br>
Copyright ¬© 2023 Cogei. All Rights Reserved.
</div>
</div>
</body>
</html>";
    
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= 'From: <sistema-automatico@cogei.net>' . "\r\n";
    $headers .= 'Reply-To: <no-reply@cogei.net>' . "\r\n";
    
    $email_sent = false;
    if ($inviamail) {
        $email_sent = mail($admin_email, $subject, $body, $headers);
    }
    
    // Log centralizzato
    AlboFornitoriMailLogger::logAdminNotification(
        $user_id,
        $rag_soc ?: 'N/A',
        $user_email,
        $admin_email,
        $email_sent,
        $documenti_log,
        !$inviamail // debug_mode
    );
}

// NUOVO REQ 2: Funzione per inviare notifica admin progresso utente nuovo
function sendAdminNewUserProgressNotification($user_id, $filled_count, $total_count, $rag_soc) {
    $inviamail = $GLOBALS["inviamail"];
    
    $admin_email = 'ufficio_qualita@cogei.net';
    $user = get_userdata($user_id);
    $user_email = $user ? $user->user_email : 'N/A';
    
    $subject = "NUOVO UTENTE: Caricamento documenti in corso";
    
    $percentage = round(($filled_count / $total_count) * 100);
    
    $body = "<html>
<head>
<title>Progresso Registrazione Nuovo Utente</title>
</head>
<body>
<div style='background: #17a2b8; color: white; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 8px;'>
<h2 style='margin: 0; color: white;'>üìù Nuovo Utente - Registrazione in Corso</h2>
</div>

<p>Ciao Admin,</p>

<p>L'utente <strong>{$rag_soc}</strong> (ID: {$user_id}) ha <strong>iniziato a caricare i documenti necessari</strong>.</p>

<div style='background: #d1ecf1; padding: 15px; border-left: 4px solid #17a2b8; margin: 20px 0; border-radius: 4px;'>
<h3 style='margin: 0 0 10px 0; color: #0c5460;'>üìä Progresso caricamento:</h3>
<div style='background: #e9ecef; border-radius: 10px; height: 30px; margin: 10px 0;'>
<div style='background: linear-gradient(90deg, #17a2b8, #138496); height: 30px; width: {$percentage}%; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;'>
{$percentage}%
</div>
</div>
<p style='margin: 5px 0 0 0; color: #0c5460;'><strong>{$filled_count}</strong> di <strong>{$total_count}</strong> documenti obbligatori caricati</p>
</div>

<div style='background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; border-radius: 4px;'>
<h3 style='margin: 0 0 10px 0; color: #856404;'>‚ÑπÔ∏è Informazioni:</h3>
‚Ä¢ Utente appena registrato (ultimi 7 giorni)<br>
‚Ä¢ Sta completando la documentazione richiesta<br>
‚Ä¢ NON √® stato disattivato automaticamente<br>
‚Ä¢ Riceverai una notifica quando completer√† tutti i documenti<br>
</div>

<p><strong>Data notifica:</strong> " . date('d/m/Y H:i:s') . "</p>
<p><strong>Email utente:</strong> {$user_email}</p>

<p>L'utente sta procedendo con la registrazione. Attendi che completi tutti i documenti prima di procedere con la verifica.</p>

<div class='footer' style='background: #03679e; padding: 10px; margin-top: 30px; border-radius: 4px;'>
<div style='text-align: center; color: white; font-size: 12px;'>
COGEI SRL - Sistema di Controllo Registrazioni<br>
Copyright ¬© 2023 Cogei. All Rights Reserved.
</div>
</div>
</body>
</html>";
    
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= 'From: <sistema-automatico@cogei.net>' . "\r\n";
    $headers .= 'Reply-To: <no-reply@cogei.net>' . "\r\n";
    
    $email_sent = false;
    if ($inviamail) {
        $email_sent = mail($admin_email, $subject, $body, $headers);
    }
    
    // Log centralizzato
    AlboFornitoriMailLogger::log([
        'ambiente' => $inviamail ? 'PROD' : 'DEBUG',
        'tipo_email' => 'NOTIFICA_ADMIN_PROGRESSO_NUOVO_UTENTE',
        'destinatario' => $admin_email,
        'oggetto' => $subject,
        'user_id' => $user_id,
        'user_name' => $rag_soc ?: 'N/A',
        'user_email' => $user_email,
        'email_sent' => $email_sent,
        'note' => "Progresso: {$filled_count}/{$total_count} documenti ({$percentage}%)"
    ]);
}

// NUOVO REQ 2: Funzione per inviare notifica admin completamento documenti utente nuovo
function sendAdminNewUserCompletionNotification($user_id, $rag_soc) {
    $inviamail = $GLOBALS["inviamail"];
    
    $admin_email = 'ufficio_qualita@cogei.net';
    $user = get_userdata($user_id);
    $user_email = $user ? $user->user_email : 'N/A';
    
    $subject = "NUOVO UTENTE: Documenti completati - Pronto per la revisione";
    
    $body = "<html>
<head>
<title>Completamento Registrazione Nuovo Utente</title>
</head>
<body>
<div style='background: #28a745; color: white; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 8px;'>
<h2 style='margin: 0; color: white;'>‚úÖ Nuovo Utente - Documenti Completati</h2>
</div>

<p>Ciao Admin,</p>

<p>L'utente <strong>{$rag_soc}</strong> (ID: {$user_id}) ha <strong>completato il caricamento di tutti i documenti obbligatori</strong>!</p>

<div style='background: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 20px 0; border-radius: 4px;'>
<h3 style='margin: 0 0 10px 0; color: #155724;'>‚úì Stato completamento:</h3>
<p style='margin: 5px 0; color: #155724; font-size: 18px;'><strong>100%</strong> - Tutti i documenti obbligatori caricati</p>
</div>

<div style='background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; border-radius: 4px;'>
<h3 style='margin: 0 0 10px 0; color: #856404;'>üîç Azione richiesta:</h3>
‚Ä¢ Verifica manualmente i documenti caricati<br>
‚Ä¢ Controlla che le date di scadenza siano corrette<br>
‚Ä¢ Attiva l'utente dal pannello BO se tutto √® conforme<br>
</div>

<p><strong>Data notifica:</strong> " . date('d/m/Y H:i:s') . "</p>
<p><strong>Email utente:</strong> {$user_email}</p>

<p>L'utente √® ora <strong>pronto per la revisione e attivazione</strong>.</p>

<div class='footer' style='background: #03679e; padding: 10px; margin-top: 30px; border-radius: 4px;'>
<div style='text-align: center; color: white; font-size: 12px;'>
COGEI SRL - Sistema di Controllo Registrazioni<br>
Copyright ¬© 2023 Cogei. All Rights Reserved.
</div>
</div>
</body>
</html>";
    
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= 'From: <sistema-automatico@cogei.net>' . "\r\n";
    $headers .= 'Reply-To: <no-reply@cogei.net>' . "\r\n";
    
    $email_sent = false;
    if ($inviamail) {
        $email_sent = mail($admin_email, $subject, $body, $headers);
    }
    
    // Log centralizzato
    AlboFornitoriMailLogger::log([
        'ambiente' => $inviamail ? 'PROD' : 'DEBUG',
        'tipo_email' => 'NOTIFICA_ADMIN_COMPLETAMENTO_NUOVO_UTENTE',
        'destinatario' => $admin_email,
        'oggetto' => $subject,
        'user_id' => $user_id,
        'user_name' => $rag_soc ?: 'N/A',
        'user_email' => $user_email,
        'email_sent' => $email_sent,
        'note' => "Tutti i documenti obbligatori completati - Pronto per attivazione"
    ]);
}

// Function to collect all users with document changes for summary display
function getAllUsersWithDocumentChanges() {
    global $wpdb;
    
    $suppliers = get_users([
        'role' => 'subscriber',
        'orderby' => 'ID',
        'order' => 'DESC'
    ]);
    
    $users_with_changes = [];
    
    foreach ($suppliers as $user) {
        $user_id = $user->ID;
        $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
        
        // Check for document changes without triggering disabling action
        createSuppliersCopyTable();
        $changed_documents = checkDocumentChangesWithoutAction($user_id);
        
        if (is_array($changed_documents) && !empty($changed_documents)) {
            $users_with_changes[] = [
                'user_id' => $user_id,
                'rag_soc' => $rag_soc ?: 'N/A',
                'email' => $user->user_email,
                'changed_documents' => $changed_documents
            ];
        }
    }
    
    return $users_with_changes;
}

// Function to check document changes without triggering disable action (for summary display)
function checkDocumentChangesWithoutAction($user_id) {
    global $wpdb;
    
    $user = get_userdata($user_id);
    if (!$user) return false;
    
    $tipo = get_user_meta($user_id, 'user_registration_tip_ut_rad', true);
    
    // Document fields to monitor
    $document_fields = [
        'user_registration_scad_CCIAA' => 'CCIAA',
        'user_registration_scad_wit' => 'White List', 
        'user_registration_scad_durc' => 'DURC',
        'user_registration_scadenza_altre_scadenze' => 'Altre Scadenze'
    ];
    
    // Add RCT-RCO field based on type
    if ($tipo === 'Lavoro' || $tipo === 'Servizi' || $tipo === 'Subappalto' || $tipo === 'Noli') {
        if ($tipo === 'Forniture') {
            $document_fields['user_registration_scad_rct_rco_forni'] = 'RCT-RCO (Forniture)';
        } else {
            $document_fields['user_registration_scad_rct_rco'] = 'RCT-RCO';
        }
    }
    
    // Get current live data
    $live_data = [];
    foreach ($document_fields as $field => $label) {
        $live_data[$field] = get_user_meta($user_id, $field, true);
    }
    
    // Get copy table data
    $copy_data = getSupplierCopyData($user_id);
    if (!$copy_data) {
        return false; // No comparison possible without copy data
    }
    
    // Compare document dates
    $changed_documents = [];
    
    // Map copy table fields to live fields
    $field_mapping = [
        'cciaa' => 'user_registration_scad_CCIAA',
        'white_list' => 'user_registration_scad_wit',
        'durc' => 'user_registration_scad_durc',
        'altre_scadenze' => 'user_registration_scadenza_altre_scadenze',
        'rct_rco' => ($tipo === 'Forniture') ? 'user_registration_scad_rct_rco_forni' : 'user_registration_scad_rct_rco'
    ];
    
    foreach ($field_mapping as $copy_field => $live_field) {
        $copy_value = $copy_data[$copy_field] ?? '';
        $live_value = $live_data[$live_field] ?? '';
        
        if ($copy_value !== $live_value && !empty($live_value)) {
            $label = $document_fields[$live_field] ?? $copy_field;
            $changed_documents[] = [
                'document' => $label,
                'old_date' => $copy_value,
                'new_date' => $live_value
            ];
        }
    }
    
    return empty($changed_documents) ? false : $changed_documents;
}

// NUOVO REQ 3: Funzione per ottenere tutti gli utenti in fase di completamento registrazione
function getAllUsersInRegistrationPhase() {
    $suppliers = get_users([
        'role' => 'subscriber',
        'orderby' => 'ID',
        'order' => 'DESC'
    ]);
    
    $users_in_registration = [];
    
    foreach ($suppliers as $user) {
        $user_id = $user->ID;
        $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
        $tipo = get_user_meta($user_id, 'user_registration_tip_ut_rad', true);
        
        // Check user status
        $status = determineSupplierStatus($user_id);
        
        // Get required documents based on type
        $document_fields = [
            'user_registration_scad_CCIAA' => 'CCIAA',
            'user_registration_scad_wit' => 'White List',
            'user_registration_scad_durc' => 'DURC',
            'user_registration_scadenza_altre_scadenze' => 'Altre Scadenze'
        ];
        
        if ($tipo === 'Lavoro' || $tipo === 'Servizi' || $tipo === 'Subappalto' || $tipo === 'Noli') {
            $document_fields['user_registration_scad_rct_rco'] = 'RCT-RCO';
        } elseif ($tipo === 'Forniture') {
            $document_fields['user_registration_scad_rct_rco_forni'] = 'RCT-RCO (Forniture)';
        }
        
        // Check document completion status and expiry
        $completed_docs = [];
        $missing_docs = [];
        $expired_docs = [];
        $total_required = count($document_fields);
        
        foreach ($document_fields as $field => $label) {
            $value = get_user_meta($user_id, $field, true);
            if (!empty($value)) {
                // Check if document is expired
                $is_expired = false;
                $converted_date = str_replace("/", "-", $value);
                try {
                    $now = new DateTime("now");
                    $expiry_date = new DateTime($converted_date . ' 23:59:59');
                    $interval = $now->diff($expiry_date);
                    $days = (int)$interval->format('%r%a');
                    
                    if ($days < 0) {
                        $is_expired = true;
                        $expired_docs[] = [
                            'label' => $label,
                            'value' => $value,
                            'days_expired' => abs($days)
                        ];
                    }
                } catch (Exception $e) {
                    // Se la data non √® valida, consideriamola come non scaduta per sicurezza
                }
                
                $completed_docs[] = [
                    'label' => $label,
                    'value' => $value,
                    'is_expired' => $is_expired
                ];
            } else {
                $missing_docs[] = $label;
            }
        }
        
        $filled_count = count($completed_docs);
        $is_incomplete = $filled_count < $total_required;
        $has_expired = !empty($expired_docs);
        
        // NUOVA LOGICA: Pronto per verifica SOLO se:
        // - Tutti i documenti obbligatori sono compilati
        // - Nessun documento √® scaduto
        // - Lo stato non √® gi√† Attivo
        $is_ready_for_review = $filled_count === $total_required && !$has_expired && $status !== 'Attivo';
        
        // SOLO utenti NON attivi con almeno un documento mancante OPPURE con tutti i documenti ma non ancora attivati
        if ($status !== 'Attivo' && ($is_incomplete || $is_ready_for_review)) {
            $users_in_registration[] = [
                'user_id' => $user_id,
                'rag_soc' => $rag_soc ?: 'N/A',
                'email' => $user->user_email,
                'tipo' => $tipo ?: 'N/A',
                'status' => $status,
                'registration_date' => date('d/m/Y H:i', strtotime($user->user_registered)),
                'completed_docs' => $completed_docs,
                'missing_docs' => $missing_docs,
                'expired_docs' => $expired_docs,
                'filled_count' => $filled_count,
                'total_required' => $total_required,
                'percentage' => round(($filled_count / $total_required) * 100),
                'is_ready_for_review' => $is_ready_for_review,
                'has_expired' => $has_expired
            ];
        }
    }
    
    // Sort: ready for review first, then by percentage completion
    usort($users_in_registration, function($a, $b) {
        if ($a['is_ready_for_review'] && !$b['is_ready_for_review']) return -1;
        if (!$a['is_ready_for_review'] && $b['is_ready_for_review']) return 1;
        return $b['percentage'] - $a['percentage'];
    });
    
    return $users_in_registration;
}

// ================== GESTIONE RICHIESTE DOCUMENTI ==================

// Create document_requests table if not exists
function createDocumentRequestsTable() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'document_requests';
    $sql = "CREATE TABLE IF NOT EXISTS $table_name (
        id int(11) NOT NULL AUTO_INCREMENT,
        user_id int(11) NOT NULL,
        richiesta_note text NOT NULL,
        data_richiesta datetime DEFAULT CURRENT_TIMESTAMP,
        richiesto_da int(11) NOT NULL,
        PRIMARY KEY (id),
        UNIQUE KEY unique_user_id (user_id),
        KEY richiesto_da (richiesto_da)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;";
    $wpdb->query($sql);
}

// Handle log deletion actions
if (isset($_POST['log_action']) && $_POST['log_action'] === 'delete_logs') {
    $log_file = ABSPATH . 'log_mail/log_mail_albo_fornitori.txt';
    
    if (file_exists($log_file) && isset($_POST['log_indices'])) {
        $indices_to_delete = array_map('intval', $_POST['log_indices']);
        
        // Read and parse log
        $log_content = file_get_contents($log_file);
        $log_lines = explode("\n", $log_content);
        
        // Parse log entries
        $log_entries = [];
        $current_entry = [];
        $entry_line_map = []; // Maps entry index to line numbers
        $current_line_start = 0;
        
        foreach ($log_lines as $line_num => $line) {
            if (preg_match('/^-{100}$/', $line)) {
                if (!empty($current_entry)) {
                    $entry_line_map[count($log_entries)] = [$current_line_start, $line_num];
                    $log_entries[] = $current_entry;
                    $current_entry = [];
                }
                $current_line_start = $line_num;
            } elseif (!empty(trim($line)) && strpos($line, '====') === false) {
                $current_entry[] = $line;
            }
        }
        
        if (!empty($current_entry)) {
            $entry_line_map[count($log_entries)] = [$current_line_start, count($log_lines) - 1];
            $log_entries[] = $current_entry;
        }
        
        // Reverse indices since we display newest first
        $log_entries_reversed = array_reverse($log_entries, true);
        $total_entries = count($log_entries);
        
        // Build new log content
        $lines_to_keep = [];
        $entry_idx = 0;
        foreach ($log_entries as $original_idx => $entry) {
            $display_idx = $total_entries - 1 - $original_idx;
            
            if (!in_array($display_idx, $indices_to_delete)) {
                // Keep this entry
                if (isset($entry_line_map[$original_idx])) {
                    $start = $entry_line_map[$original_idx][0];
                    $end = $entry_line_map[$original_idx][1];
                    for ($i = $start; $i <= $end; $i++) {
                        $lines_to_keep[] = $log_lines[$i];
                    }
                }
            }
        }
        
        // Write back to file
        if (empty($lines_to_keep)) {
            // If all deleted, recreate with header
            $header = str_repeat("=", 100) . "\n";
            $header .= "LOG EMAIL ALBO FORNITORI - " . date('Y') . "\n";
            $header .= str_repeat("=", 100) . "\n\n";
            file_put_contents($log_file, $header, LOCK_EX);
        } else {
            file_put_contents($log_file, implode("\n", $lines_to_keep), LOCK_EX);
        }
        
        // Redirect using JavaScript to avoid output buffer issues
        $deleted_count = count($indices_to_delete);
        // Get the base path from REQUEST_URI (before any query params)
        $base_path = strtok($_SERVER['REQUEST_URI'], '?');
        echo '<script type="text/javascript">';
        echo 'window.location.href = "' . esc_url($base_path) . '?tab=log&deleted=' . $deleted_count . '";';
        echo '</script>';
        exit;
    }
}

// Handle document request actions
if (isset($_POST['document_action'])) {
    $action = sanitize_text_field($_POST['document_action']);
    $user_id = intval($_POST['user_id']);
    $current_user_id = get_current_user_id();
    
    createDocumentRequestsTable();
    
    switch ($action) {
        case 'request_documents':
            $richiesta_note = sanitize_textarea_field($_POST['richiesta_note']);
            
            if (!empty($richiesta_note) && !empty($user_id)) {
                global $wpdb, $inviamail;
                
                // Handle PDF attachments
                $uploaded_files = [];
                $attachment_errors = [];
                
                if (!empty($_FILES['allegati_pdf']['name'][0])) {
                    $upload_dir = ABSPATH . 'wp-content/uploads/allegati_richieste_documenti/';
                    
                    // Ensure upload directory exists
                    if (!file_exists($upload_dir)) {
                        mkdir($upload_dir, 0755, true);
                    }
                    
                    $max_file_size = 10 * 1024 * 1024; // 10 MB
                    
                    foreach ($_FILES['allegati_pdf']['name'] as $key => $filename) {
                        if ($_FILES['allegati_pdf']['error'][$key] === UPLOAD_ERR_OK) {
                            $tmp_name = $_FILES['allegati_pdf']['tmp_name'][$key];
                            $file_size = $_FILES['allegati_pdf']['size'][$key];
                            
                            // Validate file type
                            $finfo = finfo_open(FILEINFO_MIME_TYPE);
                            $mime_type = finfo_file($finfo, $tmp_name);
                            finfo_close($finfo);
                            
                            if ($mime_type !== 'application/pdf') {
                                $attachment_errors[] = "File {$filename} non √® un PDF valido";
                                continue;
                            }
                            
                            // Validate file extension
                            $file_ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
                            if ($file_ext !== 'pdf') {
                                $attachment_errors[] = "File {$filename} deve avere estensione .pdf";
                                continue;
                            }
                            
                            // Validate file size
                            if ($file_size > $max_file_size) {
                                $attachment_errors[] = "File {$filename} supera il limite di 10 MB";
                                continue;
                            }
                            
                            // Generate safe filename (remove dots to prevent double extension exploits)
                            $safe_filename = preg_replace('/[^a-zA-Z0-9_-]/', '_', pathinfo($filename, PATHINFO_FILENAME));
                            // Ensure filename doesn't start with underscore or dash
                            $safe_filename = ltrim($safe_filename, '_-');
                            // Use first 50 chars to prevent overly long filenames
                            $safe_filename = substr($safe_filename, 0, 50);
                            $new_filename = $user_id . '_' . time() . '_' . $safe_filename . '.pdf';
                            $target_path = $upload_dir . $new_filename;
                            
                            // Move uploaded file
                            if (move_uploaded_file($tmp_name, $target_path)) {
                                // Set proper permissions
                                chmod($target_path, 0644);
                                $uploaded_files[] = $new_filename;
                            } else {
                                $attachment_errors[] = "Errore nel caricamento di {$filename}";
                            }
                        }
                    }
                }
                
                // Insert or update document request
                $result = $wpdb->replace(
                    $wpdb->prefix . 'document_requests',
                    array(
                        'user_id' => $user_id,
                        'richiesta_note' => $richiesta_note,
                        'richiesto_da' => $current_user_id
                    ),
                    array('%d', '%s', '%d')
                );
                
                if ($result) {
                    // Send email to company
                    $user = get_userdata($user_id);
                    $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true) ?: $user->display_name;
                    $admin_user = get_userdata($current_user_id);
                    
                    $subject = "Richiesta Documenti - Cogei.net";
                    
                    // Build attachments list for email
                    $attachments_html = '';
                    if (!empty($uploaded_files)) {
                        $attachments_html = '<div style="background: #e7f3ff; padding: 15px; border-left: 4px solid #0066a2; margin: 20px 0;">';
                        $attachments_html .= '<strong>üìé Allegati:</strong><br>';
                        foreach ($uploaded_files as $file) {
                            $file_url = site_url('/wp-content/uploads/allegati_richieste_documenti/' . $file);
                            $attachments_html .= '‚Ä¢ <a href="' . $file_url . '" target="_blank">' . htmlspecialchars($file) . '</a><br>';
                        }
                        $attachments_html .= '</div>';
                    }
                    
                    $body = "<html>
<head>
<title>Richiesta Documenti</title>
</head>
<body>
<div style='background: #0066a2; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 8px;'>
<h2 style='margin: 0; color: white;'>Richiesta Documenti</h2>
</div>
Gentile {$rag_soc},<br><br>
hai ricevuto una richiesta di documenti dal pannello di amministrazione:<br><br>
<div style='background: #f8f9fa; padding: 15px; border-left: 4px solid #0066a2; margin: 20px 0;'>
<strong>Richiesta:</strong><br>
{$richiesta_note}
</div>
{$attachments_html}
<strong>Richiesto da:</strong> {$admin_user->display_name}<br>
<strong>Data richiesta:</strong> " . date('d/m/Y H:i') . "<br><br>
Ti preghiamo di aggiornare i documenti richiesti nel tuo profilo fornitore.<br><br>
<div class='footer' style='background: #03679e; padding: 10px; margin-top: 20px;'>
<div style='margin-top: 40px; text-align: center; color: white; font-size: 12px !important;'>COGEI SRL - P.IVA: IT06569020636 - Copyright ¬© 2023 Cogei. All Rights Reserved.</div>
</div>
</body>
</html>";
                    
                    $headers = "MIME-Version: 1.0" . "\r\n";
                    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
                    $headers .= 'From: <no-reply@cogei.net>' . "\r\n";
                    
                    $email_sent = false;
                    if ($inviamail) {
                        $email_sent = mail($user->user_email, $subject, $body, $headers);
                    }
                    
                    // Log centralizzato
                    AlboFornitoriMailLogger::logDocumentRequest(
                        $user_id,
                        $rag_soc,
                        $user->user_email,
                        $user->user_email,
                        $email_sent,
                        $richiesta_note,
                        $uploaded_files, // allegati
                        !$inviamail // debug_mode
                    );
                    
                    $success = true;
                    $success_info = [
                        'action_type' => 'document_request',
                        'user_name' => $rag_soc,
                        'message' => 'Richiesta documenti inviata'
                    ];
                }
            }
            break;
            
        case 'cancel_request':
            global $wpdb;
            
            $result = $wpdb->delete(
                $wpdb->prefix . 'document_requests',
                array('user_id' => $user_id),
                array('%d')
            );
            
            if ($result !== false) {
                $user = get_userdata($user_id);
                $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true) ?: $user->display_name;
                
                $success = true;
                $success_info = [
                    'action_type' => 'document_request_cancelled',
                    'user_name' => $rag_soc,
                    'message' => 'Richiesta documenti rimossa'
                ];
            }
            break;
    }
    
    // Redirect after action
    $current_url = $_SERVER['REQUEST_URI'];
    $redirect_url = remove_query_arg(['msg', 'action_type', 'user_name', 'message'], $current_url);
    
    if ($success && !empty($success_info)) {
        $redirect_params = array_merge(['msg' => 'success'], $success_info);
        $redirect_url = add_query_arg($redirect_params, $redirect_url);
    } elseif ($success) {
        $redirect_url = add_query_arg('msg', 'success', $redirect_url);
    } else {
        $redirect_url = add_query_arg('msg', 'error', $redirect_url);
    }
    
    $redirect_url = html_entity_decode($redirect_url, ENT_QUOTES, 'UTF-8');
    
    if (!headers_sent()) {
        header("Location: " . $redirect_url);
        exit;
    } else {
        echo '<script>window.location.href = "' . addslashes($redirect_url) . '";</script>';
        exit;
    }
}

// ================== GESTIONE AZIONI ==================

if (isset($_GET['action']) && isset($_GET['user_id'])) {
    $user_id = intval($_GET['user_id']);
    $action = sanitize_text_field($_GET['action']);
    $success = false;
    $success_info = array();
    
    createSuppliersCopyTable();
    
    switch ($action) {
        case 'toggle_user_status':
            if (isset($_GET['new_status'])) {
                $new_status = sanitize_text_field($_GET['new_status']);
                $old_status = determineSupplierStatus($user_id);
                
                // Forza stato nel user_meta
                update_user_meta($user_id, 'forced_supplier_status', $new_status);
                
                // Sincronizza tabella copia
                $user = get_userdata($user_id);
                $tipo = get_user_meta($user_id, 'user_registration_tip_ut_rad', true);
                $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
                $rct_rco_field = ($tipo === 'Forniture') ? 'user_registration_scad_rct_rco_forni' : 'user_registration_scad_rct_rco';
                $rct_rco = get_user_meta($user_id, $rct_rco_field, true);
                $ccia = get_user_meta($user_id, 'user_registration_scad_CCIAA', true);
                $white_list = get_user_meta($user_id, 'user_registration_scad_wit', true);
                $soa = get_user_meta($user_id, 'user_registration_scad_soa', true);
                $durc = get_user_meta($user_id, 'user_registration_scad_durc', true);
                $altre = get_user_meta($user_id, 'user_registration_scadenza_altre_scadenze', true);
                
                $copy_data = getSupplierCopyData($user_id);
                $richiesta_documenti = ($copy_data && isset($copy_data['richiesta_documenti'])) ? $copy_data['richiesta_documenti'] : 0;
                
                $sync_data = [
                    'tipo' => $tipo ?: '',
                    'ragione_sociale' => $rag_soc ?: '',
                    'email' => $user->user_email,
                    'piva' => $user->display_name,
                    'rct_rco' => $rct_rco ?: '',
                    'cciaa' => $ccia ?: '',
                    'white_list' => $white_list ?: '',
                    'soa' => $soa ?: '',
                    'durc' => $durc ?: '',
                    'altre_scadenze' => $altre ?: '',
                    'stato' => $new_status,
                    'richiesta_documenti' => $richiesta_documenti
                ];
                
                updateSupplierCopyData($user_id, $sync_data);
                
                // Invia email
                if ($new_status === 'Attivo' && $old_status !== 'Attivo') {
                    sendActivationEmail($user_id);
                } elseif ($new_status === 'Disattivo' && $old_status !== 'Disattivo') {
                    sendDeactivationEmail($user_id);
                }
                
                $success = true;
                $success_info = array(
                    'action_type' => 'status_change',
                    'new_status' => $new_status,
                    'user_email' => $user->user_email,
                    'user_name' => $rag_soc ?: $user->display_name
                );
            }
            break;
    }
    
    // Redirect
    $current_url = $_SERVER['REQUEST_URI'];
    $redirect_url = remove_query_arg(['action', 'user_id', 'new_status', 'msg', 'action_type', 'target_user_id', 'user_email', 'user_name', 'return_to'], $current_url);
    
    // Check if we need to return to a specific tab
    if (isset($_GET['return_to']) && $_GET['return_to'] === 'registrazione') {
        $redirect_url = add_query_arg('tab', 'registrazione', $redirect_url);
    }
    
    if ($success && !empty($success_info)) {
        $redirect_params = array(
            'msg' => 'success',
            'action_type' => $success_info['action_type'],
            'target_user_id' => $user_id,
            'user_email' => rawurlencode($success_info['user_email']),
            'user_name' => rawurlencode($success_info['user_name'])
        );
        
        if (isset($success_info['new_status'])) {
            $redirect_params['new_status'] = $success_info['new_status'];
        }
        
        $redirect_url = add_query_arg($redirect_params, $redirect_url);
    } elseif ($success) {
        $redirect_url = add_query_arg('msg', 'success', $redirect_url);
    } else {
        $redirect_url = add_query_arg('msg', 'error', $redirect_url);
    }
    
    // Decodifica entit√† HTML per evitare problemi con &#038;
    $redirect_url = html_entity_decode($redirect_url, ENT_QUOTES, 'UTF-8');
    
    if (!headers_sent()) {
        header("Location: " . $redirect_url);
        exit;
    } else {
        echo '<script>window.location.href = "' . addslashes($redirect_url) . '";</script>';
        exit;
    }
}

// ================== CONFIGURAZIONE ==================

$supplier_statuses = [
    'Attivo' => [
        'color' => '#28a745', 
        'label' => 'Attivo',
        'tooltip' => 'Tutti i documenti richiesti sono caricati e validi. Il fornitore pu√≤ partecipare a gare e commesse.'
    ],
    'Disattivo' => [
        'color' => '#dc3545', 
        'label' => 'Disattivo',
        'tooltip' => 'Ha documenti scaduti da pi√π di 15 giorni. Il fornitore non pu√≤ partecipare a gare fino all\'aggiornamento dei documenti.'
    ],
    'Solo_Registrato' => [
        'color' => '#ffc107', 
        'label' => 'Solo Registrato',
        'tooltip' => 'Non ha caricato tutti i documenti richiesti. Deve completare la documentazione per diventare attivo.'
    ],
    'Scaduto' => [
        'color' => '#fd7e14', 
        'label' => 'Documenti Scaduti',
        'tooltip' => 'Ha documenti scaduti ma non ancora da 15 giorni. Deve rinnovare i documenti al pi√π presto.'
    ],
    'Disattivo_In_Attesa' => [
        'color' => '#6f42c1', 
        'label' => 'Disattivo + In Attesa Documenti',
        'tooltip' => '√à disattivato per documenti scaduti da pi√π di 15 giorni, ma ha caricato alcuni documenti (documentazione incompleta).'
    ],
    'Solo_Registrato_In_Attesa' => [
        'color' => '#20c997', 
        'label' => 'Registrato + In Attesa Documenti',
        'tooltip' => 'Ha caricato alcuni documenti ma non tutti quelli richiesti. Deve completare la documentazione.'
    ],
    'Richiesti_nuovi_documenti' => [
        'color' => '#e83e8c', 
        'label' => 'Richiesti Documenti',
        'tooltip' => '√à stato richiesto al fornitore di caricare nuovi documenti. In attesa di risposta.'
    ],
    'Richiesti_Documenti' => [
        'color' => '#e83e8c', 
        'label' => 'Richiesti Documenti',
        'tooltip' => '√à stato richiesto al fornitore di caricare nuovi documenti. In attesa di risposta.'
    ]
];

createSuppliersCopyTable();

// ================== OUTPUT HTML ==================

echo '<div style="margin: 20px; font-family: Arial, sans-serif;">';
echo '<h2>Gestione Fornitori</h2>';

// ================== TAB NAVIGATION ==================
$current_tab = isset($_GET['tab']) ? sanitize_text_field($_GET['tab']) : 'fornitori';

echo '<div style="margin-bottom: 20px; border-bottom: 2px solid #0066a2;">';
echo '<button onclick="switchTab(\'fornitori\')" id="tab-fornitori" class="tab-button" style="padding: 10px 20px; border: none; background: ' . ($current_tab === 'fornitori' ? '#0066a2' : '#f0f0f0') . '; color: ' . ($current_tab === 'fornitori' ? 'white' : '#333') . '; cursor: pointer; font-weight: bold; border-radius: 5px 5px 0 0; margin-right: 5px;">üìã Fornitori</button>';
echo '<button onclick="switchTab(\'registrazione\')" id="tab-registrazione" class="tab-button" style="padding: 10px 20px; border: none; background: ' . ($current_tab === 'registrazione' ? '#0066a2' : '#f0f0f0') . '; color: ' . ($current_tab === 'registrazione' ? 'white' : '#333') . '; cursor: pointer; font-weight: bold; border-radius: 5px 5px 0 0; margin-right: 5px;">üìù Utenti in Registrazione</button>';
echo '<button onclick="switchTab(\'log\')" id="tab-log" class="tab-button" style="padding: 10px 20px; border: none; background: ' . ($current_tab === 'log' ? '#0066a2' : '#f0f0f0') . '; color: ' . ($current_tab === 'log' ? 'white' : '#333') . '; cursor: pointer; font-weight: bold; border-radius: 5px 5px 0 0; margin-right: 5px;">üìß Log Email</button>';
echo '<button onclick="switchTab(\'disattivazioni\')" id="tab-disattivazioni" class="tab-button" style="padding: 10px 20px; border: none; background: ' . ($current_tab === 'disattivazioni' ? '#0066a2' : '#f0f0f0') . '; color: ' . ($current_tab === 'disattivazioni' ? 'white' : '#333') . '; cursor: pointer; font-weight: bold; border-radius: 5px 5px 0 0;">üî¥ Log Disattivazioni</button>';
echo '</div>';

// Tab Content Container
echo '<div id="tab-fornitori-content" style="display: ' . ($current_tab === 'fornitori' ? 'block' : 'none') . ';">';

// STATO EMAIL
echo '<div style="margin-bottom: 15px; padding: 10px; background: ' . ($GLOBALS['inviamail'] ? '#d4edda' : '#fff3cd') . '; border-radius: 5px; border-left: 4px solid ' . ($GLOBALS['inviamail'] ? '#28a745' : '#ffc107') . ';">';
echo '<strong>Stato Email:</strong> ' . ($GLOBALS['inviamail'] ? '<span style="color: #28a745;">ATTIVE - Le email vengono inviate</span>' : '<span style="color: #856404;">DISATTIVATE - Solo log (cambia $inviamail = true per attivare)</span>');
echo '</div>';

// CONTROLLI
echo '<div style="margin-bottom: 15px;">';
echo '<button onclick="exportTableToCSV()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Esporta CSV</button>';
echo '<span style="margin-left: 10px; font-size: 12px; color: #666;">Esporta la tabella come visualizzata (con filtri applicati)</span>';
echo '</div>';

// CAMPO DI RICERCA
echo '<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">';
echo '<strong>Cerca in tutti i campi:</strong><br>';
echo '<input type="text" id="searchInput" placeholder="Scrivi per cercare..." style="width: 100%; max-width: 400px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;" onkeyup="performSearch()">';
echo '<small style="display: block; margin-top: 5px; color: #666;">Cerca per ID, tipo, ragione sociale, email, P.IVA, stato o qualsiasi altro campo</small>';
echo '</div>';

// FILTRI STATI
echo '<div style="margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">';
echo '<strong>Filtra per Stati (seleziona multipli):</strong><br>';
echo '<button onclick="clearAllFilters()" style="background: #6c757d; color: white; padding: 4px 8px; border: none; border-radius: 8px; font-size: 11px; margin: 2px; cursor: pointer;">Pulisci Tutti</button><br><br>';

foreach ($supplier_statuses as $key => $config) {
    if ($key === 'Richiesti_Documenti' || $key === 'Richiesti_nuovi_documenti') continue;
    
    echo '<label style="display: inline-block; margin: 2px; cursor: pointer;">';
    echo '<input type="checkbox" id="status_' . $key . '" onchange="updateFilters()" style="margin-right: 5px;">';
    echo '<span style="background: ' . $config['color'] . '; color: white; padding: 4px 8px; border-radius: 8px; font-size: 11px;" title="' . htmlspecialchars($config['tooltip']) . '">' . $config['label'] . '</span>';
    echo '</label> ';
}

echo '<label style="display: inline-block; margin: 2px; cursor: pointer;">';
echo '<input type="checkbox" id="filter_richiesti_documenti" onchange="updateFilters()" style="margin-right: 5px;">';
echo '<span style="background: #e83e8c; color: white; padding: 4px 8px; border-radius: 8px; font-size: 11px;" title="√à stato richiesto al fornitore di caricare nuovi documenti. In attesa di risposta.">Richiesti Documenti</span>';
echo '</label> ';

echo '<label style="display: inline-block; margin: 2px; cursor: pointer;">';
echo '<input type="checkbox" id="filter_auto_disattivato" onchange="updateFilters()" style="margin-right: 5px;">';
echo '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 8px; font-size: 11px;" title="Utenti disattivati automaticamente per modifiche documenti">üö® Auto-Disattivato</span>';
echo '</label> ';

echo '</div>';

// FILTRI TIPOLOGIE
echo '<div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">';
echo '<strong>Filtra per Tipologie (seleziona multipli):</strong><br>';
$user_types = ['Lavoro', 'Servizi', 'Forniture', 'Subappalto', 'Noli', 'Consulenze', 'Polizze'];
echo '<button onclick="clearAllFilters()" style="background: #6c757d; color: white; padding: 4px 8px; border: none; border-radius: 8px; font-size: 11px; margin: 2px; cursor: pointer;">Pulisci Tutti</button><br><br>';

foreach ($user_types as $type) {
    echo '<label style="display: inline-block; margin: 2px; cursor: pointer;">';
    echo '<input type="checkbox" id="type_' . $type . '" onchange="updateFilters()" style="margin-right: 5px;">';
    echo '<span style="background: #2196f3; color: white; padding: 4px 8px; border-radius: 8px; font-size: 11px;">' . $type . '</span>';
    echo '</label> ';
}
echo '</div>';

// FILTRI ATTIVI
echo '<div id="active-filters" style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107; display: none;">';
echo '<strong>Filtri Attivi:</strong> <span id="filter-list"></span>';
echo '<button onclick="clearAllFilters()" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 10px; cursor: pointer;">Rimuovi Tutti</button>';
echo '</div>';

// MESSAGGI DI FEEDBACK
if (isset($_GET['msg'])) {
    $msg_type = $_GET['msg'] === 'success' ? 'success' : 'error';
    $msg_color = $msg_type === 'success' ? '#d4edda' : '#f8d7da';
    $msg_text_color = $msg_type === 'success' ? '#155724' : '#721c24';
    $msg_icon = $msg_type === 'success' ? '‚úÖ' : '‚ùå';
    
    $msg_text = $msg_icon . ' Operazione completata con successo!';
    
    if ($msg_type === 'success' && isset($_GET['action_type'])) {
        $action_type = sanitize_text_field($_GET['action_type']);
        $target_user_id = isset($_GET['target_user_id']) ? intval($_GET['target_user_id']) : 0;
        $user_email = isset($_GET['user_email']) ? rawurldecode(sanitize_email($_GET['user_email'])) : '';
        $user_name = isset($_GET['user_name']) ? rawurldecode(sanitize_text_field($_GET['user_name'])) : '';
        $new_status = isset($_GET['new_status']) ? sanitize_text_field($_GET['new_status']) : '';
        
        switch ($action_type) {
            case 'status_change':
                if ($new_status === 'Attivo') {
                    $msg_text = "üü¢ <strong>FORNITORE ATTIVATO</strong><br>";
                    $msg_text .= "‚Ä¢ <strong>ID:</strong> {$target_user_id}<br>";
                    $msg_text .= "‚Ä¢ <strong>Nome:</strong> {$user_name}<br>";
                    $msg_text .= "‚Ä¢ <strong>Email:</strong> {$user_email}<br>";
                    $msg_text .= "‚Ä¢ <strong>Nuovo Stato:</strong> ATTIVO";
                } elseif ($new_status === 'Disattivo') {
                    $msg_text = "üî¥ <strong>FORNITORE DISATTIVATO</strong><br>";
                    $msg_text .= "‚Ä¢ <strong>ID:</strong> {$target_user_id}<br>";
                    $msg_text .= "‚Ä¢ <strong>Nome:</strong> {$user_name}<br>";
                    $msg_text .= "‚Ä¢ <strong>Email:</strong> {$user_email}<br>";
                    $msg_text .= "‚Ä¢ <strong>Nuovo Stato:</strong> DISATTIVO";
                } else {
                    $msg_text = "üìù <strong>STATO FORNITORE MODIFICATO</strong><br>";
                    $msg_text .= "‚Ä¢ <strong>ID:</strong> {$target_user_id}<br>";
                    $msg_text .= "‚Ä¢ <strong>Nome:</strong> {$user_name}<br>";
                    $msg_text .= "‚Ä¢ <strong>Email:</strong> {$user_email}<br>";
                    $msg_text .= "‚Ä¢ <strong>Nuovo Stato:</strong> {$new_status}";
                }
                break;
                
            case 'request_documents':
                $msg_text = "üìã <strong>RICHIESTI NUOVI DOCUMENTI</strong><br>";
                $msg_text .= "‚Ä¢ <strong>ID:</strong> {$target_user_id}<br>";
                $msg_text .= "‚Ä¢ <strong>Nome:</strong> {$user_name}<br>";
                $msg_text .= "‚Ä¢ <strong>Email:</strong> {$user_email}<br>";
                $msg_text .= "‚Ä¢ <strong>Azione:</strong> Contrassegnato come 'Richiesti Documenti'";
                break;
                
            case 'remove_request':
                $msg_text = "üóëÔ∏è <strong>RIMOSSA RICHIESTA DOCUMENTI</strong><br>";
                $msg_text .= "‚Ä¢ <strong>ID:</strong> {$target_user_id}<br>";
                $msg_text .= "‚Ä¢ <strong>Nome:</strong> {$user_name}<br>";
                $msg_text .= "‚Ä¢ <strong>Email:</strong> {$user_email}<br>";
                $msg_text .= "‚Ä¢ <strong>Azione:</strong> Rimosso flag 'Richiesti Documenti'";
                break;
        }
    }
    
    if ($msg_type === 'error') {
        $msg_text = $msg_icon . ' Errore durante l\'operazione';
    }
    
    echo '<div id="feedback-message" style="margin-bottom: 15px; padding: 15px; background: ' . $msg_color . '; color: ' . $msg_text_color . '; border-radius: 8px; border-left: 5px solid ' . ($msg_type === 'success' ? '#28a745' : '#dc3545') . '; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    echo '<div style="font-size: 14px; line-height: 1.5;">' . $msg_text . '</div>';
    if ($msg_type === 'success') {
        echo '<div id="countdown-text" style="font-size: 11px; color: #6c757d; margin-top: 8px; font-style: italic;">Questo messaggio scomparir√† automaticamente tra <span id="countdown-seconds">10</span> secondi...</div>';
    }
    echo '</div>';
}

// ================== RIEPILOGO MODIFICHE DOCUMENTI ==================

// Get all users with document changes for summary
$users_with_changes = getAllUsersWithDocumentChanges();

if (!empty($users_with_changes)) {
    echo '<div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #ffc107; overflow: hidden;">';
    
    // Accordion Header (clickable)
    echo '<div onclick="toggleDocumentChangesAccordion()" style="background: rgba(255, 193, 7, 0.2); padding: 15px 20px; cursor: pointer; user-select: none; border-bottom: 1px solid #ffc107;" onmouseover="this.style.background=\'rgba(255, 193, 7, 0.3)\'" onmouseout="this.style.background=\'rgba(255, 193, 7, 0.2)\'">';
    echo '<h3 style="color: #856404; margin: 0; display: flex; align-items: center; justify-content: space-between;">';
    echo '<span>üö® Riepilogo Utenti con Modifiche Documenti <span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">' . count($users_with_changes) . ' utenti</span></span>';
    echo '<span id="accordion-arrow" style="font-size: 16px; transition: transform 0.3s ease;">‚ñº</span>';
    echo '</h3>';
    echo '</div>';
    
    // Accordion Content (initially collapsed)
    echo '<div id="document-changes-content" style="display: none; padding: 20px;">';
    echo '<div style="display: grid; gap: 15px;">';
    foreach ($users_with_changes as $user_info) {
        echo '<div style="background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; padding: 15px; border-left: 4px solid #dc3545;">';
        echo '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">';
        echo '<div>';
        echo '<strong style="color: #721c24; font-size: 14px;">üè¢ ' . htmlspecialchars($user_info['rag_soc']) . '</strong>';
        echo '<div style="font-size: 12px; color: #6c757d; margin-top: 2px;">';
        echo '<strong>ID:</strong> ' . $user_info['user_id'] . ' | ';
        echo '<strong>Email:</strong> ' . htmlspecialchars($user_info['email']);
        echo '</div>';
        echo '</div>';
        echo '<span style="background: #dc3545; color: white; padding: 1px 6px; border-radius: 10px; font-size: 10px;">AUTO-DISATTIVATO</span>';
        echo '</div>';
        
        echo '<div style="margin-top: 10px;">';
        echo '<strong style="color: #721c24; font-size: 12px;">üìÑ Documenti modificati:</strong>';
        echo '<div style="margin-top: 5px; font-size: 11px; line-height: 1.4;">';
        foreach ($user_info['changed_documents'] as $change) {
            echo '<div style="background: rgba(220,53,69,0.1); padding: 4px 8px; margin: 2px 0; border-radius: 3px;">';
            echo '<strong style="color: #721c24;">‚Ä¢ ' . $change['document'] . '</strong><br>';
            echo '<span style="color: #6c757d;">&nbsp;&nbsp;da "' . htmlspecialchars($change['old_date']) . '" a "' . htmlspecialchars($change['new_date']) . '"</span>';
            echo '</div>';
        }
        echo '</div>';
        echo '</div>';
        echo '</div>';
    }
    echo '</div>';
    
    echo '<div style="margin-top: 15px; padding: 10px; background: rgba(220,53,69,0.1); border-radius: 4px; font-size: 12px; color: #721c24;">';
    echo '<strong>‚ÑπÔ∏è Nota:</strong> Questi utenti sono stati automaticamente disattivati a causa di modifiche recenti ai documenti non ancora revisionate. ';
    echo '√à stata inviata una notifica email all\'amministratore per ogni modifica rilevata.';
    echo '</div>';
    
    echo '</div>'; // Close accordion content
    echo '</div>'; // Close accordion container
} else {
    echo '<div style="background: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 5px solid #28a745;">';
    echo '<h4 style="color: #155724; margin: 0; display: flex; align-items: center;">‚úÖ Nessuna Modifica Rilevata</h4>';
    echo '<p style="margin: 8px 0 0 0; font-size: 14px; color: #155724;">Tutti i fornitori hanno i documenti sincronizzati. Nessuna disattivazione automatica necessaria.</p>';
    echo '</div>';
}

// TABELLA
echo '<div style="max-height: 800px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">';
echo '<table style="width: 100%; border-collapse: collapse;">';
echo '<thead style="position: sticky; top: 0; z-index: 10;">';
echo '<tr style="background: #0066a2 !important; color: white !important;">';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">ID</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">Tipo</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">Campo Utente</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">Ragione Sociale</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">Email</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">P.IVA</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">RCT-RCO</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">CCIA</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">White List</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">SOA</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">DURC</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">Altre Scadenze</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">Stato</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">üìÑ Nota richiesta documenti</th>';
echo '<th style="padding: 10px; border: 1px solid #ddd; background: #0066a2 !important; color: white !important;">Azioni</th>';
echo '</tr>';
echo '</thead>';
echo '<tbody>';

$suppliers = get_users([
    'role' => 'subscriber',
    'orderby' => 'ID',
    'order' => 'DESC'
]);

foreach ($suppliers as $user) {
    $user_id = $user->ID;
    $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true);
    $tipo = get_user_meta($user_id, 'user_registration_tip_ut_rad', true);
    
    // Determina campo utente specifico in base al tipo
    $user_campo_spec = '';
    switch ($tipo) {
        case 'Lavoro':
            $campo_array = get_user_meta($user_id, 'user_registration_campo_lav', false);
            if (!empty($campo_array) && is_array($campo_array)) {
                // Get first element if it's an array of arrays
                $campo_data = is_array($campo_array[0]) ? $campo_array[0] : $campo_array;
                $user_campo_spec = is_array($campo_data) ? implode(', ', $campo_data) : $campo_data;
            }
            break;
        case 'Servizi':
            $campo_array = get_user_meta($user_id, 'user_registration_campo_servizi', false);
            if (!empty($campo_array) && is_array($campo_array)) {
                $campo_data = is_array($campo_array[0]) ? $campo_array[0] : $campo_array;
                $user_campo_spec = is_array($campo_data) ? implode(', ', $campo_data) : $campo_data;
            }
            break;
        case 'Forniture':
            $campo_array = get_user_meta($user_id, 'user_registration_campo_forniture', false);
            if (!empty($campo_array) && is_array($campo_array)) {
                $campo_data = is_array($campo_array[0]) ? $campo_array[0] : $campo_array;
                $user_campo_spec = is_array($campo_data) ? implode(', ', $campo_data) : $campo_data;
            }
            break;
        case 'Subappalto':
            $user_campo_spec = 'VUOTO';
            break;
        case 'Noli':
            $campo_array = get_user_meta($user_id, 'user_registration_campo_noli', false);
            if (!empty($campo_array) && is_array($campo_array)) {
                $campo_data = is_array($campo_array[0]) ? $campo_array[0] : $campo_array;
                $user_campo_spec = is_array($campo_data) ? implode(', ', $campo_data) : $campo_data;
            }
            break;
        case 'Consulenze':
            $campo_array = get_user_meta($user_id, 'user_registration_campo_consulenze', false);
            if (!empty($campo_array) && is_array($campo_array)) {
                $campo_data = is_array($campo_array[0]) ? $campo_array[0] : $campo_array;
                $user_campo_spec = is_array($campo_data) ? implode(', ', $campo_data) : $campo_data;
            }
            break;
        case 'Polizze':
            $campo_array = get_user_meta($user_id, 'user_registration_campo_polizze', false);
            if (!empty($campo_array) && is_array($campo_array)) {
                $campo_data = is_array($campo_array[0]) ? $campo_array[0] : $campo_array;
                $user_campo_spec = is_array($campo_data) ? implode(', ', $campo_data) : $campo_data;
            }
            break;
        default:
            $user_campo_spec = 'N/A';
            break;
    }
    
    // Calcola dati dinamici
    $rct_rco_field = ($tipo === 'Forniture') ? 'user_registration_scad_rct_rco_forni' : 'user_registration_scad_rct_rco';
    $rct_rco = get_user_meta($user_id, $rct_rco_field, true);
    $ccia = get_user_meta($user_id, 'user_registration_scad_CCIAA', true);
    $white_list = get_user_meta($user_id, 'user_registration_scad_wit', true);
    $soa = get_user_meta($user_id, 'user_registration_scad_soa', true);
    $durc = get_user_meta($user_id, 'user_registration_scad_durc', true);
    $altre = get_user_meta($user_id, 'user_registration_scadenza_altre_scadenze', true);
    
    // üö® NUOVO: Controllo automatico modifiche documenti
    createSuppliersCopyTable(); // Assicura che la tabella copia esista
    $changed_documents = checkDocumentChangesAndDisableUser($user_id);
    $was_disabled = is_array($changed_documents) && !empty($changed_documents);
    
    // Calcola stato dinamico
    $dynamic_status = determineSupplierStatus($user_id);
    
    // Controlla richiesta documenti (nuovo sistema)
    $document_request = getDocumentRequest($user_id);
    $has_document_request = !empty($document_request);
    
    $can_activate = hasDocuments($user_id);
    $status_config = $supplier_statuses[$dynamic_status];
    
    // Get WordPress registration date for data attribute
    $registration_date = '';
    if (!empty($user->user_registered)) {
        $registration_date = date('d/m/Y H:i', strtotime($user->user_registered));
    }
    
    // Determina stile riga: rosso per Disattivo e stati non attivi
    $row_style = 'border-bottom: 1px solid #ddd;';
    if ($dynamic_status === 'Disattivo' || $dynamic_status === 'Disattivo_In_Attesa' || $dynamic_status === 'Solo_Registrato_In_Attesa') {
        $row_style .= ' background-color: #f8d7da;';
    }
    
    echo '<tr style="' . $row_style . '" class="supplier-row" data-status="' . $dynamic_status . '" data-type="' . ($tipo ?: 'N/A') . '" data-richiesta-documenti="' . ($has_document_request ? '1' : '0') . '" data-auto-disattivato="' . ($was_disabled ? '1' : '0') . '" data-registration-date="' . esc_attr($registration_date) . '">';
    echo '<td style="padding: 8px; border: 1px solid #ddd;">' . $user_id . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd;">' . ($tipo ?: 'N/A') . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">' . ($user_campo_spec ?: 'N/A') . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd;">' . ($rag_soc ?: 'N/A') . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd;">' . $user->user_email . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd;">' . $user->display_name . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">' . renderExpiryCell($rct_rco) . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">' . renderExpiryCell($ccia) . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">' . renderExpiryCell($white_list) . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">' . renderExpiryCell($soa) . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">' . renderExpiryCell($durc) . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">' . renderExpiryCell($altre) . '</td>';
    echo '<td style="padding: 8px; border: 1px solid #ddd;">';
    
    // Mostra stato con tooltip
    echo '<span class="supplier-status" style="background: ' . $status_config['color'] . '; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px;" title="' . htmlspecialchars($status_config['tooltip']) . '">' . $status_config['label'] . '</span>';
    
    // üö® Indicatore disattivazione automatica
    if ($was_disabled) {
        echo '<br><span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-top: 3px; display: inline-block; animation: pulse 2s infinite;" title="Disattivato automaticamente per modifiche ai documenti">üö® AUTO-DISATTIVATO</span>';
        
        // Mostra i documenti modificati
        echo '<br><div style="background: #f8d7da; color: #721c24; padding: 6px; border-radius: 4px; font-size: 9px; margin-top: 4px; border-left: 3px solid #dc3545;">';
        echo '<strong>üìÑ Documenti modificati:</strong><br>';
        foreach ($changed_documents as $change) {
            echo '‚Ä¢ <strong>' . $change['document'] . '</strong><br>';
            echo '&nbsp;&nbsp;da "' . htmlspecialchars($change['old_date']) . '"<br>';
            echo '&nbsp;&nbsp;a "' . htmlspecialchars($change['new_date']) . '"<br>';
        }
        echo '</div>';
    }
    
    echo '</td>';
    
    // Nuova colonna: Nota richiesta documenti
    echo '<td style="padding: 8px; border: 1px solid #ddd;">';
    if ($has_document_request) {
        echo '<div style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 4px; border-left: 3px solid #ffc107; font-size: 11px;">';
        echo '<strong>üìÑ Richiesta attiva</strong><br>';
        echo '<div style="margin-top: 4px; font-size: 10px;">';
        echo '<strong>Nota:</strong> ' . htmlspecialchars(substr($document_request['richiesta_note'], 0, 100)) . (strlen($document_request['richiesta_note']) > 100 ? '...' : '') . '<br>';
        echo '<strong>Data:</strong> ' . date('d/m/Y H:i', strtotime($document_request['data_richiesta']));
        echo '</div>';
        echo '</div>';
    } else {
        echo '<span style="color: #6c757d; font-style: italic; font-size: 11px;">Nessuna richiesta</span>';
    }
    echo '</td>';
    
    // Actions column
    echo '<td style="padding: 8px; border: 1px solid #ddd;">';
    
    // Pulsanti azioni
    // Utenti non attivi: Disattivo, Disattivo_In_Attesa, Solo_Registrato_In_Attesa
    if ($dynamic_status === 'Disattivo' || $dynamic_status === 'Disattivo_In_Attesa' || $dynamic_status === 'Solo_Registrato_In_Attesa') {
        if ($can_activate) {
            $current_url = $_SERVER['REQUEST_URI'];
            $base_url = strtok($current_url, '?');
            $activate_url = $base_url . '?action=toggle_user_status&user_id=' . $user_id . '&new_status=Attivo';
            echo '<a href="' . esc_url($activate_url) . '" onclick="return confirm(\'Confermi attivazione?\')" style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-right: 5px; text-decoration: none; display: inline-block;">ATTIVA</a>';
        } else {
            echo '<span style="background: #ccc; padding: 3px 8px; border-radius: 3px; font-size: 11px; color: #666; margin-right: 5px;" title="Nessun documento caricato">ATTIVA</span>';
        }
    } else {
        $current_url = $_SERVER['REQUEST_URI'];
        $base_url = strtok($current_url, '?');
        $deactivate_url = $base_url . '?action=toggle_user_status&user_id=' . $user_id . '&new_status=Disattivo';
        echo '<a href="' . esc_url($deactivate_url) . '" onclick="return confirm(\'Confermi disattivazione?\')" style="background: #dc3545; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-right: 5px; text-decoration: none; display: inline-block;">DISATTIVA</a>';
    }
    
    // Document request buttons (BO HSE style)
    $rag_soc = get_user_meta($user_id, 'user_registration_rag_soc', true) ?: $user->display_name;
    
    if ($has_document_request) {
        // Show cancel button if there's an active request
        echo '<br><button onclick="cancelDocumentRequest(' . $user_id . ', \'' . addslashes($rag_soc) . '\')" style="background: #6c757d; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; text-decoration: none; display: inline-block; margin-top: 2px;">üóëÔ∏è CANCELLA RICHIESTA DOCUMENTI</button>';
    } else {
        // Show request button if no active request
        echo '<br><button onclick="openDocumentRequestModal(' . $user_id . ', \'' . addslashes($rag_soc) . '\')" style="background: #17a2b8; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; text-decoration: none; display: inline-block; margin-top: 2px;">üìÑ RICHIEDI DOCUMENTI</button>';
    }
    
    echo '</td>';
    echo '</tr>';
}

echo '</tbody>';
echo '</table>';
echo '</div>'; // Close scrollable wrapper

// Close fornitori tab
echo '</div>'; // End tab-fornitori-content

// ================== NUOVO REQ 3: TAB UTENTI IN REGISTRAZIONE ==================
echo '<div id="tab-registrazione-content" style="display: ' . ($current_tab === 'registrazione' ? 'block' : 'none') . ';">';
echo '<h3 style="color: #0066a2; margin-top: 0;">üìù Utenti in Fase di Completamento Registrazione</h3>';

echo '<div style="margin-bottom: 15px; padding: 15px; background: #e7f3ff; border-left: 4px solid #0066a2; border-radius: 4px;">';
echo '<strong>‚ÑπÔ∏è Informazioni:</strong> Questa sezione mostra:<br>';
echo '‚Ä¢ Utenti NON attivi con documenti obbligatori mancanti<br>';
echo '‚Ä¢ Utenti pronti per la verifica (tutti i documenti completati e non scaduti, anche se autodisattivati)<br>';
echo '‚Ä¢ Gli utenti autodisattivati con tutti i documenti validi sono considerati pronti per la verifica';
echo '</div>';

$users_in_registration = getAllUsersInRegistrationPhase();

if (empty($users_in_registration)) {
    echo '<div style="padding: 30px; text-align: center; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">';
    echo '<p style="font-size: 16px; color: #666; margin: 0;">‚úÖ Nessun utente in fase di registrazione</p>';
    echo '<p style="font-size: 13px; color: #999; margin: 10px 0 0 0;">Tutti gli utenti sono attivi oppure non hanno ancora iniziato a caricare documenti.</p>';
    echo '</div>';
} else {
    // Filters
    echo '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">';
    echo '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">';
    echo '<div style="display: flex; gap: 15px; align-items: center;">';
    echo '<strong>üîç Filtri:</strong>';
    echo '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">';
    echo '<input type="checkbox" id="filter-ready-review" onchange="filterRegistrationUsers()" checked>';
    echo '<span>Pronti per verifica (' . array_reduce($users_in_registration, function($c, $u) { return $c + ($u['is_ready_for_review'] ? 1 : 0); }, 0) . ')</span>';
    echo '</label>';
    echo '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">';
    echo '<input type="checkbox" id="filter-in-progress" onchange="filterRegistrationUsers()" checked>';
    echo '<span>In completamento (' . array_reduce($users_in_registration, function($c, $u) { return $c + (!$u['is_ready_for_review'] ? 1 : 0); }, 0) . ')</span>';
    echo '</label>';
    echo '</div>';
    echo '<button onclick="clearRegistrationFilters()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">Pulisci Filtri</button>';
    echo '</div>';
    echo '</div>';
    
    echo '<div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">';
    echo '<strong>üìä Statistiche:</strong> <strong id="total-users-count">' . count($users_in_registration) . '</strong> utent' . (count($users_in_registration) === 1 ? 'e' : 'i') . ' in fase di registrazione';
    
    // Count ready for review
    $ready_count = 0;
    foreach ($users_in_registration as $reg_user) {
        if ($reg_user['is_ready_for_review']) {
            $ready_count++;
        }
    }
    if ($ready_count > 0) {
        echo ' | <strong style="color: #28a745;">' . $ready_count . '</strong> pront' . ($ready_count === 1 ? 'o' : 'i') . ' per la verifica';
    }
    echo '</div>';
    
    // Display users in a 2-column grid
    echo '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">';
    
    foreach ($users_in_registration as $reg_user) {
        $border_color = $reg_user['is_ready_for_review'] ? '#28a745' : '#ffc107';
        $bg_color = $reg_user['is_ready_for_review'] ? '#d4edda' : '#fff3cd';
        $header_bg = $reg_user['is_ready_for_review'] ? '#28a745' : '#ffc107';
        
        $data_attrs = 'data-ready="' . ($reg_user['is_ready_for_review'] ? '1' : '0') . '"';
        
        echo '<div class="registration-user-card" ' . $data_attrs . ' style="border: 2px solid ' . $border_color . '; border-radius: 8px; padding: 0; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
        
        // Header
        echo '<div style="background: ' . $header_bg . '; color: white; padding: 15px; border-radius: 6px 6px 0 0;">';
        echo '<div style="display: flex; justify-content: space-between; align-items: center;">';
        echo '<div>';
        echo '<h4 style="margin: 0; font-size: 18px;">' . htmlspecialchars($reg_user['rag_soc']) . '</h4>';
        echo '<p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 13px;">ID: ' . $reg_user['user_id'] . ' | Email: ' . htmlspecialchars($reg_user['email']) . ' | Stato: ' . htmlspecialchars($reg_user['status']) . '</p>';
        echo '</div>';
        echo '<div style="text-align: right;">';
        if ($reg_user['is_ready_for_review']) {
            echo '<span style="background: white; color: #28a745; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px;">‚úÖ PRONTO PER VERIFICA</span>';
        } else {
            echo '<span style="background: white; color: #856404; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px;">‚è≥ IN COMPLETAMENTO</span>';
        }
        echo '</div>';
        echo '</div>';
        echo '</div>';
        
        // Content
        echo '<div style="padding: 20px;">';
        
        // Info row
        echo '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        echo '<div><strong>Tipo:</strong> ' . htmlspecialchars($reg_user['tipo']) . '</div>';
        echo '<div><strong>Registrato il:</strong> ' . $reg_user['registration_date'] . '</div>';
        echo '<div><strong>Stato attuale:</strong> <span style="color: #dc3545; font-weight: bold;">' . htmlspecialchars($reg_user['status']) . '</span></div>';
        echo '</div>';
        
        // Progress bar
        echo '<div style="margin-bottom: 20px;">';
        echo '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
        echo '<strong style="font-size: 16px;">üìä Progresso Documenti</strong>';
        echo '<span style="font-size: 18px; font-weight: bold; color: ' . $header_bg . ';">' . $reg_user['percentage'] . '%</span>';
        echo '</div>';
        echo '<div style="background: #e9ecef; border-radius: 10px; height: 35px; position: relative; overflow: hidden;">';
        echo '<div style="background: linear-gradient(90deg, ' . $header_bg . ', ' . ($reg_user['is_ready_for_review'] ? '#1e7e34' : '#e0a800') . '); height: 35px; width: ' . $reg_user['percentage'] . '%; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: width 0.3s ease;">';
        if ($reg_user['percentage'] > 20) {
            echo $reg_user['filled_count'] . '/' . $reg_user['total_required'];
        }
        echo '</div>';
        if ($reg_user['percentage'] <= 20) {
            echo '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #666;">' . $reg_user['filled_count'] . '/' . $reg_user['total_required'] . '</div>';
        }
        echo '</div>';
        echo '</div>';
        
        // Documents sections
        echo '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
        
        // Completed documents
        echo '<div>';
        echo '<h4 style="color: #28a745; margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #28a745;">‚úì Documenti Completati (' . count($reg_user['completed_docs']) . ')</h4>';
        if (!empty($reg_user['completed_docs'])) {
            echo '<div style="background: #d4edda; padding: 12px; border-radius: 6px; border-left: 4px solid #28a745;">';
            foreach ($reg_user['completed_docs'] as $doc) {
                $is_expired = isset($doc['is_expired']) && $doc['is_expired'];
                $bg_color = $is_expired ? '#fff3cd' : 'transparent';
                $text_color = $is_expired ? '#856404' : '#155724';
                $icon = $is_expired ? '‚ö†Ô∏è' : '‚úì';
                
                echo '<div style="padding: 6px 0; border-bottom: 1px solid #c3e6cb; font-size: 13px; background: ' . $bg_color . '; padding: 8px; margin-bottom: 4px; border-radius: 4px;">';
                echo '<strong style="color: ' . $text_color . ';">' . $icon . ' ' . htmlspecialchars($doc['label']) . '</strong><br>';
                echo '<span style="color: ' . $text_color . '; margin-left: 15px;">Scadenza: ' . htmlspecialchars($doc['value']) . '</span>';
                if ($is_expired) {
                    echo '<span style="color: #dc3545; margin-left: 10px; font-weight: bold;">‚ö†Ô∏è SCADUTO</span>';
                }
                echo '</div>';
            }
            echo '</div>';
        } else {
            echo '<p style="color: #6c757d; font-style: italic; font-size: 13px;">Nessun documento caricato</p>';
        }
        echo '</div>';
        
        // Missing documents OR Expired documents section
        echo '<div>';
        
        // Show expired documents if present
        if (!empty($reg_user['expired_docs'])) {
            echo '<h4 style="color: #ffc107; margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #ffc107;">‚ö†Ô∏è Documenti Scaduti (' . count($reg_user['expired_docs']) . ')</h4>';
            echo '<div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 15px;">';
            foreach ($reg_user['expired_docs'] as $doc) {
                echo '<div style="padding: 6px 0; border-bottom: 1px solid #ffeeba; font-size: 13px;">';
                echo '<strong style="color: #856404;">‚ö†Ô∏è ' . htmlspecialchars($doc['label']) . '</strong><br>';
                echo '<span style="color: #856404; margin-left: 15px;">Scaduto da: ' . $doc['days_expired'] . ' giorni</span>';
                echo '</div>';
            }
            echo '</div>';
        }
        
        // Then show missing documents
        echo '<h4 style="color: #dc3545; margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #dc3545;">‚úó Documenti Mancanti (' . count($reg_user['missing_docs']) . ')</h4>';
        if (!empty($reg_user['missing_docs'])) {
            echo '<div style="background: #f8d7da; padding: 12px; border-radius: 6px; border-left: 4px solid #dc3545;">';
            foreach ($reg_user['missing_docs'] as $doc) {
                echo '<div style="padding: 6px 0; border-bottom: 1px solid #f5c6cb; font-size: 13px;">';
                echo '<strong style="color: #721c24;">‚úó ' . htmlspecialchars($doc) . '</strong>';
                echo '</div>';
            }
            echo '</div>';
        } else {
            echo '<p style="color: #28a745; font-weight: bold; font-size: 13px;">‚úì Tutti i documenti obbligatori completati!</p>';
        }
        echo '</div>';
        
        echo '</div>'; // End grid
        
        // Warning message if documents are expired
        if (!empty($reg_user['expired_docs']) && $reg_user['filled_count'] === $reg_user['total_required']) {
            echo '<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">';
            echo '<strong style="color: #856404;">‚ö†Ô∏è Attenzione:</strong> ';
            echo '<span style="color: #856404;">L\'utente ha tutti i documenti obbligatori compilati ma alcuni sono scaduti. Aggiorna le date scadute prima di poter attivare l\'utente.</span>';
            echo '</div>';
        }
        
        // Action buttons (only for ready users)
        if ($reg_user['is_ready_for_review']) {
            echo '<div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e9ecef;">';
            echo '<div style="display: flex; justify-content: flex-end; gap: 10px;">';
            
            $current_url = $_SERVER['REQUEST_URI'];
            $base_url = strtok($current_url, '?');
            $activate_url = $base_url . '?action=toggle_user_status&user_id=' . $reg_user['user_id'] . '&new_status=Attivo&return_to=registrazione';
            
            echo '<a href="' . esc_url($activate_url) . '" onclick="return confirm(\'Confermi l\\\'attivazione di ' . addslashes($reg_user['rag_soc']) . '?\\n\\nVerifica che tutti i documenti siano corretti prima di procedere.\')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; text-decoration: none; display: inline-block;">‚úÖ ATTIVA UTENTE</a>';
            echo '</div>';
            echo '</div>';
        }
        
        echo '</div>'; // End content padding
        echo '</div>'; // End user card
    }
    
    echo '</div>'; // End 2-column grid
}

echo '</div>'; // End tab-registrazione-content

// ================== LOG EMAIL TAB ==================
echo '<div id="tab-log-content" style="display: ' . ($current_tab === 'log' ? 'block' : 'none') . ';">';
echo '<h3 style="color: #0066a2; margin-top: 0;">üìß Log Email Albo Fornitori</h3>';

// Show deletion success message
if (isset($_GET['deleted']) && is_numeric($_GET['deleted'])) {
    $deleted_count = intval($_GET['deleted']);
    echo '<div style="padding: 15px; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; margin-bottom: 15px; color: #155724;">';
    echo '<strong>‚úÖ Successo:</strong> ' . $deleted_count . ' ' . ($deleted_count === 1 ? 'voce eliminata' : 'voci eliminate') . ' dal log.';
    echo '</div>';
}

$log_file = ABSPATH . 'log_mail/log_mail_albo_fornitori.txt';

if (file_exists($log_file)) {
    $log_content = file_get_contents($log_file);
    $log_lines = explode("\n", $log_content);
    
    // Parse log entries
    $log_entries = [];
    $current_entry = [];
    
    foreach ($log_lines as $line) {
        if (preg_match('/^-{100}$/', $line)) {
            if (!empty($current_entry)) {
                $log_entries[] = $current_entry;
                $current_entry = [];
            }
        } elseif (!empty(trim($line)) && strpos($line, '====') === false) {
            $current_entry[] = $line;
        }
    }
    
    if (!empty($current_entry)) {
        $log_entries[] = $current_entry;
    }
    
    // Reverse to show newest first
    $log_entries = array_reverse($log_entries);
    
    // Pagination
    $per_page = 20;
    $current_page = isset($_GET['log_page']) ? max(1, intval($_GET['log_page'])) : 1;
    $total_entries = count($log_entries);
    $total_pages = ceil($total_entries / $per_page);
    $offset = ($current_page - 1) * $per_page;
    $page_entries = array_slice($log_entries, $offset, $per_page);
    
    echo '<div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-left: 4px solid #0066a2; border-radius: 4px;">';
    echo '<strong>‚ÑπÔ∏è Informazioni:</strong> Mostra le ultime ' . $per_page . ' voci per pagina. Totale: ' . $total_entries . ' voci nel log.';
    echo '</div>';
    
    // Bulk actions form start
    echo '<form id="log-delete-form" method="POST" onsubmit="return confirmLogDeletion()">';
    echo '<input type="hidden" name="log_action" value="delete_logs">';
    
    // Bulk actions toolbar
    echo '<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">';
    echo '<div>';
    echo '<label style="margin-right: 15px;"><input type="checkbox" id="select-all-logs" onchange="toggleAllLogs(this.checked)"> <strong>Seleziona tutto</strong></label>';
    echo '<button type="submit" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">üóëÔ∏è Elimina Selezionati</button>';
    echo '<span id="selected-count" style="margin-left: 10px; color: #666; font-size: 13px;"></span>';
    echo '</div>';
    echo '<div>';
    echo '<button type="button" onclick="if(confirm(\'Confermi di voler eliminare TUTTE le voci del log?\')) { deleteAllLogs(); }" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">üóëÔ∏è Elimina Tutto</button>';
    echo '</div>';
    echo '</div>';
    
    // Pagination controls
    if ($total_pages > 1) {
        echo '<div style="margin-bottom: 15px; text-align: center;">';
        echo '<span style="margin-right: 10px;">Pagina ' . $current_page . ' di ' . $total_pages . '</span>';
        
        if ($current_page > 1) {
            echo '<button onclick="switchToLogPage(' . ($current_page - 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">‚Üê Precedente</button>';
        }
        
        $start_page = max(1, $current_page - 2);
        $end_page = min($total_pages, $current_page + 2);
        
        for ($i = $start_page; $i <= $end_page; $i++) {
            $style = $i === $current_page ? 'background: #0066a2; color: white;' : 'background: #f0f0f0;';
            echo '<button onclick="switchToLogPage(' . $i . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer; ' . $style . '">' . $i . '</button>';
        }
        
        if ($current_page < $total_pages) {
            echo '<button onclick="switchToLogPage(' . ($current_page + 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">Successiva ‚Üí</button>';
        }
        echo '</div>';
    }
    
    // Display log entries
    $entry_index = 0;
    foreach ($page_entries as $entry) {
        if (empty($entry)) continue;
        
        $global_index = $offset + $entry_index; // Calculate global index for this entry
        
        $first_line = $entry[0] ?? '';
        
        // Parse timestamp and type
        preg_match('/\[(.*?)\] \[(.*?)\] (.*)/', $first_line, $matches);
        $timestamp = $matches[1] ?? '';
        $ambiente = $matches[2] ?? '';
        $tipo = $matches[3] ?? '';
        
        // Determine color based on environment
        $env_color = $ambiente === 'DEBUG' ? '#ffc107' : '#28a745';
        $env_bg = $ambiente === 'DEBUG' ? '#fff3cd' : '#d4edda';
        
        // Determine color based on email type
        $tipo_colors = [
            'ATTIVAZIONE_UTENTE' => ['bg' => '#d4edda', 'text' => '#155724'],                      // Verde
            'DISATTIVAZIONE_UTENTE' => ['bg' => '#f8d7da', 'text' => '#721c24'],                  // Rosso
            'RICHIESTA_DOCUMENTI' => ['bg' => '#d1ecf1', 'text' => '#0c5460'],                    // Ciano
            'NOTIFICA_ADMIN_MODIFICHE_DOCUMENTI' => ['bg' => '#fff3cd', 'text' => '#856404'],     // Giallo
            'AVVISO_SCADENZA_15_GIORNI' => ['bg' => '#e7f3ff', 'text' => '#004085'],              // Blu chiaro
            'AVVISO_SCADENZA_5_GIORNI' => ['bg' => '#fff3cd', 'text' => '#856404'],               // Giallo/arancio
            'AVVISO_SCADENZA_OGGI' => ['bg' => '#ffe5e5', 'text' => '#c82333'],                   // Rosso chiaro
            'AVVISO_DISATTIVAZIONE_15_GIORNI' => ['bg' => '#f8d7da', 'text' => '#721c24'],        // Rosso scuro
            'DISATTIVAZIONE_AUTOMATICA' => ['bg' => '#343a40', 'text' => '#ffffff']               // Nero
        ];
        
        $tipo_style = $tipo_colors[$tipo] ?? ['bg' => '#e9ecef', 'text' => '#495057']; // Default grigio
        
        echo '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">';
        
        // Header with checkbox and ID
        echo '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">';
        echo '<div style="display: flex; align-items: center;">';
        echo '<input type="checkbox" class="log-checkbox" name="log_indices[]" value="' . $global_index . '" onchange="updateSelectedCount()" style="margin-right: 10px; cursor: pointer;">';
        echo '<span style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 10px;">ID: ' . $global_index . '</span>';
        echo '<span style="background: ' . $env_bg . '; color: ' . $env_color . '; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 10px;">' . htmlspecialchars($ambiente) . '</span>';
        echo '<span style="background: ' . $tipo_style['bg'] . '; color: ' . $tipo_style['text'] . '; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold;">' . htmlspecialchars($tipo) . '</span>';
        echo '</div>';
        echo '<span style="color: #666; font-size: 12px;">üïí ' . htmlspecialchars($timestamp) . '</span>';
        echo '</div>';
        
        // Content
        echo '<div style="font-family: monospace; font-size: 12px; line-height: 1.6;">';
        for ($i = 1; $i < count($entry); $i++) {
            $line = $entry[$i];
            if (empty(trim($line))) continue;
            
            // Highlight important fields
            if (strpos($line, 'Destinatario:') === 0) {
                echo '<div style="margin: 5px 0;"><strong style="color: #0066a2;">üìß ' . htmlspecialchars($line) . '</strong></div>';
            } elseif (strpos($line, 'Oggetto:') === 0) {
                echo '<div style="margin: 5px 0;"><strong style="color: #333;">‚úâÔ∏è ' . htmlspecialchars($line) . '</strong></div>';
            } elseif (strpos($line, 'Utente:') === 0) {
                echo '<div style="margin: 5px 0;"><strong style="color: #6c757d;">üë§ ' . htmlspecialchars($line) . '</strong></div>';
            } elseif (strpos($line, 'Stato:') === 0) {
                $is_success = strpos($line, 'SUCCESSO') !== false || strpos($line, 'INVIATA') !== false;
                $status_color = $is_success ? '#28a745' : ($ambiente === 'DEBUG' ? '#ffc107' : '#dc3545');
                echo '<div style="margin: 5px 0;"><strong style="color: ' . $status_color . ';">‚úì ' . htmlspecialchars($line) . '</strong></div>';
            } elseif (strpos($line, 'Documenti coinvolti:') === 0 || strpos($line, 'Allegati:') === 0) {
                echo '<div style="margin: 5px 0; color: #666;"><strong>' . htmlspecialchars($line) . '</strong></div>';
            } elseif (preg_match('/^  - /', $line)) {
                echo '<div style="margin: 2px 0 2px 15px; color: #666;">üìÑ ' . htmlspecialchars(trim($line)) . '</div>';
            } else {
                echo '<div style="margin: 2px 0; color: #666;">' . htmlspecialchars($line) . '</div>';
            }
        }
        echo '</div>';
        echo '</div>';
        
        $entry_index++; // Increment for next entry
    }
    
    echo '</form>'; // Close log deletion form
    
    // Pagination controls (bottom)
    if ($total_pages > 1) {
        echo '<div style="margin-top: 15px; text-align: center;">';
        echo '<span style="margin-right: 10px;">Pagina ' . $current_page . ' di ' . $total_pages . '</span>';
        
        if ($current_page > 1) {
            echo '<button onclick="switchToLogPage(' . ($current_page - 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">‚Üê Precedente</button>';
        }
        
        for ($i = $start_page; $i <= $end_page; $i++) {
            $style = $i === $current_page ? 'background: #0066a2; color: white;' : 'background: #f0f0f0;';
            echo '<button onclick="switchToLogPage(' . $i . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer; ' . $style . '">' . $i . '</button>';
        }
        
        if ($current_page < $total_pages) {
            echo '<button onclick="switchToLogPage(' . ($current_page + 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">Successiva ‚Üí</button>';
        }
        echo '</div>';
    }
    
} else {
    echo '<div style="padding: 30px; text-align: center; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">';
    echo '<p style="font-size: 16px; color: #666; margin: 0;">üì≠ Nessun log disponibile</p>';
    echo '<p style="font-size: 13px; color: #999; margin: 10px 0 0 0;">Il file log verr√† creato automaticamente al primo invio email.</p>';
    echo '</div>';
}

echo '</div>'; // End tab-log-content

// ================== LOG DISATTIVAZIONI TAB ==================
echo '<div id="tab-disattivazioni-content" style="display: ' . ($current_tab === 'disattivazioni' ? 'block' : 'none') . ';">';
echo '<h3 style="color: #0066a2; margin-top: 0;">üî¥ Log Disattivazioni Automatiche</h3>';

echo '<div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">';
echo '<strong>‚ÑπÔ∏è Informazioni:</strong> Questo log registra tutte le disattivazioni automatiche eseguite dal cron quando i documenti scadono da oltre 15 giorni.';
echo '</div>';

$disattivazioni_log = ABSPATH . 'log_mail/log_cron_disattivazioni.txt';

if (file_exists($disattivazioni_log)) {
    $log_content = file_get_contents($disattivazioni_log);
    $log_lines = explode("\n", $log_content);
    
    // Filter out empty lines and headers
    $log_lines = array_filter($log_lines, function($line) {
        $trimmed = trim($line);
        return !empty($trimmed) && strpos($trimmed, '===') === false;
    });
    
    // Reverse to show newest first
    $log_lines = array_reverse(array_values($log_lines));
    
    // Pagination
    $per_page = 30;
    $current_dis_page = isset($_GET['dis_page']) ? max(1, intval($_GET['dis_page'])) : 1;
    $total_lines = count($log_lines);
    $total_dis_pages = ceil($total_lines / $per_page);
    $offset = ($current_dis_page - 1) * $per_page;
    $page_lines = array_slice($log_lines, $offset, $per_page);
    
    echo '<div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-left: 4px solid #0066a2; border-radius: 4px;">';
    echo '<strong>‚ÑπÔ∏è Statistiche:</strong> Mostra ' . $per_page . ' voci per pagina. Totale disattivazioni registrate: <strong>' . $total_lines . '</strong>';
    echo '</div>';
    
    // Pagination controls (top)
    if ($total_dis_pages > 1) {
        echo '<div style="margin-bottom: 15px; text-align: center;">';
        echo '<span style="margin-right: 10px;">Pagina ' . $current_dis_page . ' di ' . $total_dis_pages . '</span>';
        
        if ($current_dis_page > 1) {
            echo '<button onclick="switchToDisattivazioniPage(' . ($current_dis_page - 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">‚Üê Precedente</button>';
        }
        
        $start_page = max(1, $current_dis_page - 2);
        $end_page = min($total_dis_pages, $current_dis_page + 2);
        
        for ($i = $start_page; $i <= $end_page; $i++) {
            $style = $i === $current_dis_page ? 'background: #0066a2; color: white;' : 'background: #f0f0f0;';
            echo '<button onclick="switchToDisattivazioniPage(' . $i . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer; ' . $style . '">' . $i . '</button>';
        }
        
        if ($current_dis_page < $total_dis_pages) {
            echo '<button onclick="switchToDisattivazioniPage(' . ($current_dis_page + 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">Successiva ‚Üí</button>';
        }
        echo '</div>';
    }
    
    // Display log entries
    foreach ($page_lines as $index => $line) {
        if (empty(trim($line))) continue;
        
        // Calculate unique ID: total lines minus current position (newest = highest ID)
        $entry_num = $total_lines - ($offset + $index);
        
        // Parse timestamp and message
        if (preg_match('/\[(.*?)\] (.*)/', $line, $matches)) {
            $timestamp = $matches[1] ?? '';
            $message = $matches[2] ?? '';
            
            // Extract user ID if present
            $user_id_match = '';
            if (preg_match('/Fornitore ID (\d+)/', $message, $id_matches)) {
                $user_id_match = $id_matches[1];
            }
            
            echo '<div style="border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f8d7da; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">';
            
            // Header
            echo '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
            echo '<div>';
            echo '<span style="background: #721c24; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 10px;">ID LOG: ' . $entry_num . '</span>';
            if (!empty($user_id_match)) {
                echo '<span style="background: #856404; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">USER ID: ' . htmlspecialchars($user_id_match) . '</span>';
            }
            echo '</div>';
            echo '<span style="color: #721c24; font-size: 12px; font-weight: bold;">üïí ' . htmlspecialchars($timestamp) . '</span>';
            echo '</div>';
            
            // Content
            echo '<div style="padding: 10px; background: white; border-radius: 4px; border-left: 4px solid #dc3545;">';
            echo '<p style="margin: 0; color: #721c24; font-size: 14px; line-height: 1.5;"><strong>üî¥ ' . htmlspecialchars($message) . '</strong></p>';
            echo '</div>';
            
            echo '</div>';
        } else {
            // Fallback for non-standard format
            echo '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: #f8f9fa;">';
            echo '<p style="margin: 0; font-family: monospace; font-size: 12px; color: #666;">' . htmlspecialchars($line) . '</p>';
            echo '</div>';
        }
    }
    
    // Pagination controls (bottom)
    if ($total_dis_pages > 1) {
        echo '<div style="margin-top: 15px; text-align: center;">';
        echo '<span style="margin-right: 10px;">Pagina ' . $current_dis_page . ' di ' . $total_dis_pages . '</span>';
        
        if ($current_dis_page > 1) {
            echo '<button onclick="switchToDisattivazioniPage(' . ($current_dis_page - 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">‚Üê Precedente</button>';
        }
        
        for ($i = $start_page; $i <= $end_page; $i++) {
            $style = $i === $current_dis_page ? 'background: #0066a2; color: white;' : 'background: #f0f0f0;';
            echo '<button onclick="switchToDisattivazioniPage(' . $i . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer; ' . $style . '">' . $i . '</button>';
        }
        
        if ($current_dis_page < $total_dis_pages) {
            echo '<button onclick="switchToDisattivazioniPage(' . ($current_dis_page + 1) . ')" style="padding: 5px 10px; margin: 0 2px; cursor: pointer;">Successiva ‚Üí</button>';
        }
        echo '</div>';
    }
    
} else {
    echo '<div style="padding: 30px; text-align: center; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">';
    echo '<p style="font-size: 16px; color: #666; margin: 0;">üì≠ Nessuna disattivazione registrata</p>';
    echo '<p style="font-size: 13px; color: #999; margin: 10px 0 0 0;">Il log verr√† popolato quando il cron esegue disattivazioni automatiche.</p>';
    echo '</div>';
}

echo '</div>'; // End tab-disattivazioni-content

// Document Request Modal
echo '<div id="document-request-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">';
echo '<div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: none; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">';
echo '<div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 20px; margin: 0; border-radius: 8px 8px 0 0;">';
echo '<div style="display: flex; justify-content: space-between; align-items: center;">';
echo '<h4 style="margin: 0;">üìÑ Richiesta Documenti</h4>';
echo '<button onclick="closeDocumentRequestModal()" style="background: transparent; color: white; border: none; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">√ó</button>';
echo '</div>';
echo '<p style="margin: 8px 0 0 0; opacity: 0.9;">Azienda: <span id="document-azienda-name"></span></p>';
echo '</div>';
echo '<form id="document-request-form" method="POST" enctype="multipart/form-data" onsubmit="return validateDocumentRequest()" style="padding: 20px;">';
echo '<input type="hidden" name="document_action" value="request_documents">';
echo '<input type="hidden" name="user_id" id="document-user-id" value="">';
echo '<div style="margin-bottom: 20px;">';
echo '<label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">üìù Descrizione richiesta documenti:</label>';
echo '<textarea name="richiesta_note" id="document-richiesta-note" rows="4" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;" placeholder="Inserisci i dettagli della richiesta documenti..."></textarea>';
echo '</div>';
echo '<div style="margin-bottom: 20px;">';
echo '<label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">üìé Allegati PDF (opzionale):</label>';
echo '<input type="file" name="allegati_pdf[]" id="document-allegati" multiple accept=".pdf,application/pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
echo '<small style="display: block; margin-top: 5px; color: #6c757d;">Puoi allegare uno o pi√π file PDF (max 10 MB ciascuno)</small>';
echo '</div>';
echo '<div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">';
echo '<p style="margin: 0; font-size: 14px; color: #495057;"><strong>‚ÑπÔ∏è Informazioni:</strong></p>';
echo '<ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #6c757d;">';
echo '<li>Verr√† inviata una email automatica all\'azienda</li>';
echo '<li>La richiesta verr√† registrata nel sistema</li>';
echo '<li>Gli allegati PDF saranno inclusi nell\'email</li>';
echo '<li>Puoi cancellare la richiesta in qualsiasi momento</li>';
echo '</ul>';
echo '</div>';
echo '<div style="text-align: right;">';
echo '<button type="button" onclick="closeDocumentRequestModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Annulla</button>';
echo '<button type="submit" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">üìÑ Invia Richiesta</button>';
echo '</div>';
echo '</form>';
echo '</div>';
echo '</div>';

echo '</div>';

// ================== JAVASCRIPT BASE ==================
?>
<script>
function exportTableToCSV() {
    var table = document.querySelector("table");
    if (!table) {
        alert("Tabella non trovata!");
        return;
    }
    
    var csv = [];
    var exportedRows = 0;
    
    // Header semplificato (solo 6 colonne come da richiesta)
    var headerRow = ["ID", "Ragione Sociale", "Email", "P.IVA", "Stato", "Data Registrazione"];
    csv.push(headerRow.map(h => '"' + h + '"').join(","));
    
    var dataRows = table.querySelectorAll("tr.supplier-row");
    for (var i = 0; i < dataRows.length; i++) {
        var row = dataRows[i];
        var isVisible = window.getComputedStyle(row).display !== "none";
        
        if (isVisible) {
            var cols = row.querySelectorAll("td");
            
            // Estrai solo le colonne necessarie: ID(0), Ragione Sociale(2), Email(3), P.IVA(4), Stato(11)
            if (cols.length > 11) {
                var id = cols[0].textContent.trim();
                var ragioneSociale = cols[2].textContent.trim().replace(/[\r\n]+/g, " ").replace(/"/g, '""');
                var email = cols[3].textContent.trim().replace(/[\r\n]+/g, " ").replace(/"/g, '""');
                var piva = cols[4].textContent.trim().replace(/[\r\n]+/g, " ").replace(/"/g, '""');
                
                // Per lo stato, prendiamo solo il testo del badge stato, non tutto il contenuto della cella
                var statoCell = cols[11];
                var statusSpan = statoCell.querySelector('.supplier-status');
                var stato = statusSpan ? statusSpan.textContent.trim() : statoCell.textContent.trim().split('\n')[0];
                stato = stato.replace(/[\r\n]+/g, " ").replace(/"/g, '""');
                
                // Data registrazione - recupera dal data attribute
                var dataRegistrazione = row.getAttribute('data-registration-date') || '';
                
                var csvRow = [
                    '"' + id + '"',
                    '"' + ragioneSociale + '"', 
                    '"' + email + '"',
                    '"' + piva + '"',
                    '"' + stato + '"',
                    '"' + dataRegistrazione + '"'
                ];
                
                csv.push(csvRow.join(","));
                exportedRows++;
            }
        }
    }
    
    var csvContent = "\uFEFF" + csv.join("\n");
    var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    
    var link = document.createElement("a");
    if (link.download !== undefined) {
        var url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "fornitori_" + new Date().toISOString().slice(0,19).replace(/:/g, "-") + ".csv");
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        var totalRows = dataRows.length;
        var message = "File CSV scaricato! " + exportedRows + " fornitori esportati (6 colonne: ID, Ragione Sociale, Email, P.IVA, Stato, Data Registrazione)";
        if (exportedRows < totalRows) {
            message += " (Filtri applicati: " + (totalRows - exportedRows) + " righe nascoste)";
        }
        alert(message);
    } else {
        alert("Browser non supporta download automatico");
    }
}

function performSearch() {
    var searchInput = document.getElementById("searchInput");
    var searchTerm = searchInput ? searchInput.value : "";
    
    if (!searchTerm || searchTerm.trim() === "" || searchTerm === "Scrivi per cercare...") {
        updateFilters();
        return;
    }
    
    var rows = document.querySelectorAll(".supplier-row");
    var visibleAfterSearch = 0;
    
    rows.forEach(function(row) {
        var rowText = row.textContent.toLowerCase();
        var matchesSearch = rowText.includes(searchTerm.toLowerCase());
        
        if (matchesSearch && shouldRowBeVisible(row)) {
            row.style.display = "";
            visibleAfterSearch++;
        } else {
            row.style.display = "none";
        }
    });
    
    updateActiveFiltersDisplay(visibleAfterSearch);
}

function shouldRowBeVisible(row) {
    var selectedStatuses = [];
    var statusCheckboxes = document.querySelectorAll("input[id^=status_]:checked");
    statusCheckboxes.forEach(function(checkbox) {
        selectedStatuses.push(checkbox.id.replace("status_", ""));
    });
    
    var selectedTypes = [];
    var typeCheckboxes = document.querySelectorAll("input[id^=type_]:checked");
    typeCheckboxes.forEach(function(checkbox) {
        selectedTypes.push(checkbox.id.replace("type_", ""));
    });
    
    var richiestiDocumentiFilter = document.getElementById("filter_richiesti_documenti");
    var showOnlyRichiestiDocumenti = richiestiDocumentiFilter && richiestiDocumentiFilter.checked;
    
    var autoDisattivatoFilter = document.getElementById("filter_auto_disattivato");
    var showOnlyAutoDisattivato = autoDisattivatoFilter && autoDisattivatoFilter.checked;
    
    if (selectedStatuses.length === 0 && selectedTypes.length === 0 && !showOnlyRichiestiDocumenti && !showOnlyAutoDisattivato) {
        return true;
    }
    
    if (selectedStatuses.length > 0) {
        var rowStatus = row.getAttribute("data-status");
        
        // Logica speciale: se "Disattivo" √® selezionato, mostra anche stati non attivi correlati
        var disattivoSelected = selectedStatuses.indexOf("Disattivo") !== -1;
        var nonActiveStatuses = ["Disattivo", "Disattivo_In_Attesa", "Solo_Registrato_In_Attesa"];
        
        if (disattivoSelected && nonActiveStatuses.indexOf(rowStatus) !== -1) {
            // Mostra se √® uno degli stati non attivi e "Disattivo" √® selezionato
            return true;
        } else if (selectedStatuses.indexOf(rowStatus) === -1) {
            // Altrimenti controlla match esatto
            return false;
        }
    }
    
    if (selectedTypes.length > 0) {
        var rowType = row.getAttribute("data-type");
        if (selectedTypes.indexOf(rowType) === -1) {
            return false;
        }
    }
    
    if (showOnlyRichiestiDocumenti) {
        var hasRichiestaDocumenti = row.getAttribute("data-richiesta-documenti") === "1";
        if (!hasRichiestaDocumenti) {
            return false;
        }
    }
    
    if (showOnlyAutoDisattivato) {
        var hasAutoDisattivato = row.getAttribute("data-auto-disattivato") === "1";
        if (!hasAutoDisattivato) {
            return false;
        }
    }
    
    return true;
}

function updateFilters() {
    var rows = document.querySelectorAll(".supplier-row");
    var visibleCount = 0;
    
    rows.forEach(function(row) {
        if (shouldRowBeVisible(row)) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    });
    
    var searchInput = document.getElementById("searchInput");
    var searchTerm = searchInput ? searchInput.value : "";
    
    if (searchTerm && searchTerm.trim() !== "" && searchTerm !== "Scrivi per cercare...") {
        performSearch();
    } else {
        updateActiveFiltersDisplay(visibleCount);
    }
}

function clearAllFilters() {
    var allCheckboxes = document.querySelectorAll("input[type=checkbox]");
    allCheckboxes.forEach(function(checkbox) {
        checkbox.checked = false;
    });
    
    var searchInput = document.getElementById("searchInput");
    if (searchInput) {
        searchInput.value = "";
    }
    
    var rows = document.querySelectorAll(".supplier-row");
    rows.forEach(function(row) {
        row.style.display = "";
    });
    
    var activeFiltersDiv = document.getElementById("active-filters");
    if (activeFiltersDiv) {
        activeFiltersDiv.style.display = "none";
    }
}

function updateActiveFiltersDisplay(visibleCount) {
    var selectedStatuses = [];
    var statusCheckboxes = document.querySelectorAll("input[id^=status_]:checked");
    statusCheckboxes.forEach(function(checkbox) {
        selectedStatuses.push(checkbox.id.replace("status_", ""));
    });
    
    var selectedTypes = [];
    var typeCheckboxes = document.querySelectorAll("input[id^=type_]:checked");
    typeCheckboxes.forEach(function(checkbox) {
        selectedTypes.push(checkbox.id.replace("type_", ""));
    });
    
    var richiestiDocumentiFilter = document.getElementById("filter_richiesti_documenti");
    var showOnlyRichiestiDocumenti = richiestiDocumentiFilter && richiestiDocumentiFilter.checked;
    
    var autoDisattivatoFilter = document.getElementById("filter_auto_disattivato");
    var showOnlyAutoDisattivato = autoDisattivatoFilter && autoDisattivatoFilter.checked;
    
    var activeFiltersDiv = document.getElementById("active-filters");
    var filterList = document.getElementById("filter-list");
    var filters = [];
    
    if (selectedStatuses.length > 0) {
        filters.push("Stati: " + selectedStatuses.join(", "));
    }
    
    if (selectedTypes.length > 0) {
        filters.push("Tipi: " + selectedTypes.join(", "));
    }
    
    if (showOnlyRichiestiDocumenti) {
        filters.push("Richiesti Documenti: Si");
    }
    
    if (showOnlyAutoDisattivato) {
        filters.push("Auto-Disattivato: Si");
    }
    
    var searchInput = document.getElementById("searchInput");
    var searchTerm = searchInput ? searchInput.value : "";
    
    if (searchTerm && searchTerm.trim() !== "" && searchTerm !== "Scrivi per cercare...") {
        filters.push('Ricerca: "' + searchTerm + '"');
    }
    
    if (filters.length > 0) {
        activeFiltersDiv.style.display = "block";
        filterList.textContent = filters.join(" | ") + " (" + visibleCount + " risultati)";
    } else {
        activeFiltersDiv.style.display = "none";
    }
}

// Auto-hide messaggi feedback con countdown
function hideFeedbackMessage() {
    var feedbackMessage = document.getElementById('feedback-message');
    var countdownElement = document.getElementById('countdown-seconds');
    
    if (feedbackMessage) {
        var secondsLeft = 10;
        
        // Aggiorna il countdown ogni secondo
        var countdownInterval = setInterval(function() {
            secondsLeft--;
            if (countdownElement) {
                countdownElement.textContent = secondsLeft;
            }
            
            if (secondsLeft <= 0) {
                clearInterval(countdownInterval);
                
                // Fade out
                feedbackMessage.style.transition = 'opacity 0.5s ease';
                feedbackMessage.style.opacity = '0';
                
                setTimeout(function() {
                    feedbackMessage.style.display = 'none';
                    
                    // Pulisci URL dai parametri del messaggio
                    var currentUrl = new URL(window.location);
                    var urlChanged = false;
                    
                    var paramsToRemove = ['msg', 'action_type', 'target_user_id', 'user_email', 'user_name', 'new_status'];
                    paramsToRemove.forEach(function(param) {
                        if (currentUrl.searchParams.has(param)) {
                            currentUrl.searchParams.delete(param);
                            urlChanged = true;
                        }
                    });
                    
                    if (urlChanged) {
                        window.history.replaceState({}, document.title, currentUrl.toString());
                    }
                }, 500);
            }
        }, 1000);
    }
}

// Inizializzazione
document.addEventListener("DOMContentLoaded", function() {
    var rows = document.querySelectorAll(".supplier-row");
    rows.forEach(function(row) {
        row.style.display = "";
    });
    
    var activeFiltersDiv = document.getElementById("active-filters");
    if (activeFiltersDiv) {
        activeFiltersDiv.style.display = "none";
    }
    
    var searchInput = document.getElementById("searchInput");
    if (searchInput) {
        searchInput.value = "";
    }
    
    hideFeedbackMessage();
});

// ================== DOCUMENT REQUEST FUNCTIONS ==================

function openDocumentRequestModal(userId, aziendaName) {
    const modal = document.getElementById('document-request-modal');
    const userIdInput = document.getElementById('document-user-id');
    const aziendaNameSpan = document.getElementById('document-azienda-name');
    const notesTextarea = document.getElementById('document-richiesta-note');
    
    userIdInput.value = userId;
    aziendaNameSpan.textContent = aziendaName;
    notesTextarea.value = '';
    notesTextarea.focus();
    
    modal.style.display = 'block';
}

function closeDocumentRequestModal() {
    const modal = document.getElementById('document-request-modal');
    modal.style.display = 'none';
}

function validateDocumentRequest() {
    const notes = document.getElementById('document-richiesta-note').value.trim();
    const fileInput = document.getElementById('document-allegati');
    
    if (!notes) {
        alert('‚ö†Ô∏è Inserisci una nota per la richiesta documenti');
        document.getElementById('document-richiesta-note').focus();
        return false;
    }
    
    if (notes.length < 10) {
        alert('‚ö†Ô∏è La richiesta deve contenere almeno 10 caratteri');
        document.getElementById('document-richiesta-note').focus();
        return false;
    }
    
    // Validate file uploads
    if (fileInput.files.length > 0) {
        const maxSize = 10 * 1024 * 1024; // 10 MB
        for (let i = 0; i < fileInput.files.length; i++) {
            const file = fileInput.files[i];
            
            // Check file type
            if (file.type !== 'application/pdf') {
                alert('‚ö†Ô∏è Solo file PDF sono accettati. File non valido: ' + file.name);
                return false;
            }
            
            // Check file size
            if (file.size > maxSize) {
                alert('‚ö†Ô∏è File troppo grande: ' + file.name + '\nLa dimensione massima √® 10 MB.');
                return false;
            }
        }
    }
    
    return confirm('Confermi l\'invio della richiesta documenti all\'azienda?');
}

function submitDocumentRequest() {
    // This function is no longer used, kept for backward compatibility
    const form = document.getElementById('document-request-form');
    if (validateDocumentRequest()) {
        form.submit();
    }
}

function cancelDocumentRequest(userId, aziendaName) {
    if (confirm(`Confermi la cancellazione della richiesta documenti per ${aziendaName}?\n\nQuesta azione rimuover√† definitivamente la nota richiesta.`)) {
        // Create temporary form for submission
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'document_action';
        actionInput.value = 'cancel_request';
        
        const userIdInput = document.createElement('input');
        userIdInput.type = 'hidden';
        userIdInput.name = 'user_id';
        userIdInput.value = userId;
        
        form.appendChild(actionInput);
        form.appendChild(userIdInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('document-request-modal');
    if (event.target === modal) {
        closeDocumentRequestModal();
    }
}

// ================== TAB SWITCHING ==================

function switchTab(tabName) {
    // Hide all tab contents
    document.getElementById('tab-fornitori-content').style.display = 'none';
    document.getElementById('tab-registrazione-content').style.display = 'none';
    document.getElementById('tab-log-content').style.display = 'none';
    document.getElementById('tab-disattivazioni-content').style.display = 'none';
    
    // Remove active styling from all buttons
    var buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(function(btn) {
        btn.style.background = '#f0f0f0';
        btn.style.color = '#333';
    });
    
    // Show selected tab and update button style
    if (tabName === 'fornitori') {
        document.getElementById('tab-fornitori-content').style.display = 'block';
        document.getElementById('tab-fornitori').style.background = '#0066a2';
        document.getElementById('tab-fornitori').style.color = 'white';
        
        // Update URL without reload
        var url = new URL(window.location);
        url.searchParams.set('tab', 'fornitori');
        window.history.pushState({}, '', url);
    } else if (tabName === 'registrazione') {
        document.getElementById('tab-registrazione-content').style.display = 'block';
        document.getElementById('tab-registrazione').style.background = '#0066a2';
        document.getElementById('tab-registrazione').style.color = 'white';
        
        // Update URL without reload
        var url = new URL(window.location);
        url.searchParams.set('tab', 'registrazione');
        window.history.pushState({}, '', url);
    } else if (tabName === 'log') {
        document.getElementById('tab-log-content').style.display = 'block';
        document.getElementById('tab-log').style.background = '#0066a2';
        document.getElementById('tab-log').style.color = 'white';
        
        // Update URL without reload
        var url = new URL(window.location);
        url.searchParams.set('tab', 'log');
        window.history.pushState({}, '', url);
    } else if (tabName === 'disattivazioni') {
        document.getElementById('tab-disattivazioni-content').style.display = 'block';
        document.getElementById('tab-disattivazioni').style.background = '#0066a2';
        document.getElementById('tab-disattivazioni').style.color = 'white';
        
        // Update URL without reload
        var url = new URL(window.location);
        url.searchParams.set('tab', 'disattivazioni');
        window.history.pushState({}, '', url);
    }
}

function switchToLogPage(page) {
    var url = new URL(window.location);
    url.searchParams.set('tab', 'log');
    url.searchParams.set('log_page', page);
    window.location.href = url.toString();
}

function switchToDisattivazioniPage(page) {
    var url = new URL(window.location);
    url.searchParams.set('tab', 'disattivazioni');
    url.searchParams.set('dis_page', page);
    window.location.href = url.toString();
}

// ================== REGISTRATION TAB FILTER FUNCTIONS ==================

function filterRegistrationUsers() {
    const showReady = document.getElementById('filter-ready-review').checked;
    const showInProgress = document.getElementById('filter-in-progress').checked;
    
    const cards = document.querySelectorAll('.registration-user-card');
    let visibleCount = 0;
    
    cards.forEach(function(card) {
        const isReady = card.getAttribute('data-ready') === '1';
        let shouldShow = false;
        
        if (isReady && showReady) {
            shouldShow = true;
        } else if (!isReady && showInProgress) {
            shouldShow = true;
        }
        
        if (shouldShow) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Update count
    const countElement = document.getElementById('total-users-count');
    if (countElement) {
        countElement.textContent = visibleCount;
    }
}

function clearRegistrationFilters() {
    document.getElementById('filter-ready-review').checked = true;
    document.getElementById('filter-in-progress').checked = true;
    filterRegistrationUsers();
}

// ================== LOG DELETION FUNCTIONS ==================

function toggleAllLogs(checked) {
    const checkboxes = document.querySelectorAll('.log-checkbox');
    checkboxes.forEach(function(cb) {
        cb.checked = checked;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.log-checkbox:checked');
    const count = checkboxes.length;
    const countSpan = document.getElementById('selected-count');
    const selectAllCheckbox = document.getElementById('select-all-logs');
    
    if (countSpan) {
        if (count > 0) {
            countSpan.textContent = '(' + count + ' selezionat' + (count === 1 ? 'a' : 'e') + ')';
            countSpan.style.fontWeight = 'bold';
            countSpan.style.color = '#dc3545';
        } else {
            countSpan.textContent = '';
        }
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.log-checkbox');
    if (selectAllCheckbox && allCheckboxes.length > 0) {
        selectAllCheckbox.checked = count === allCheckboxes.length;
    }
}

function confirmLogDeletion() {
    const checkboxes = document.querySelectorAll('.log-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('‚ö†Ô∏è Seleziona almeno una voce da eliminare');
        return false;
    }
    
    return confirm('Confermi di voler eliminare ' + checkboxes.length + ' ' + (checkboxes.length === 1 ? 'voce' : 'voci') + ' dal log?\n\nQuesta azione non pu√≤ essere annullata.');
}

function deleteAllLogs() {
    // Select all checkboxes
    const checkboxes = document.querySelectorAll('.log-checkbox');
    checkboxes.forEach(function(cb) {
        cb.checked = true;
    });
    
    // Submit the form
    document.getElementById('log-delete-form').submit();
}

// Accordion functionality for document changes summary
function toggleDocumentChangesAccordion() {
    const content = document.getElementById('document-changes-content');
    const arrow = document.getElementById('accordion-arrow');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}
</script>

<style>
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>

<?php
?>